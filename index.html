<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>è‚¡ç¥¨ç­›é€‰å·¥å…·</title>
    <!-- Tailwind CSS æœ¬åœ°æ–‡ä»¶ -->
    <script src="/static/tailwindcss.min.js"></script>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- ç­›é€‰åŒºåŸŸ -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-4">
        <!-- åŸºç¡€ç­›é€‰ -->
        <div class="flex flex-wrap gap-4 mb-6">
          <div class="flex-1 min-w-[200px]">
            <label
              for="stockCode"
              class="block font-semibold text-gray-700 mb-2"
            >
              è‚¡ç¥¨ä»£ç 
            </label>
            <div
              class="flex items-center gap-2 border-2 border-gray-200 rounded-lg px-4 py-2 focus:outline-none focus:border-blue-300 focus:ring-2 focus:ring-blue-200 transition-colors"
            >
              <input
                type="text"
                id="stockCode"
                class="flex-1 text-sm outline-none"
                placeholder="å¦‚: 00700ï¼ˆç•™ç©ºåˆ™ç­›é€‰æ‰€æœ‰è‚¡ç¥¨ï¼‰"
              />
              <svg
                id="searchStockCodeBtn"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 16 16"
                class="-ml-0.5 size-4 fill-gray-600 dark:fill-gray-500 cursor-pointer"
              >
                <path
                  fill-rule="evenodd"
                  d="M9.965 11.026a5 5 0 1 1 1.06-1.06l2.755 2.754a.75.75 0 1 1-1.06 1.06l-2.755-2.754ZM10.5 7a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0Z"
                  clip-rule="evenodd"
                ></path>
              </svg>
            </div>
          </div>

          <div class="flex-1 min-w-[200px]">
            <label for="date" class="block font-semibold text-gray-700 mb-2">
              æŒ‡å®šæ—¥æœŸ
            </label>
            <input
              type="date"
              id="date"
              class="w-full text-sm px-4 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-300 focus:ring-2 focus:ring-blue-200 transition-colors"
              required
            />
          </div>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div id="fundamentalFilter">
          <!-- ç­›é€‰æ¡ä»¶æ ‡é¢˜ -->
          <div class="mb-4">
            <h3 class="font-semibold text-gray-600 flex items-center">
              åŸºæœ¬é¢ç­›é€‰ï¼ˆä»…åœ¨æœªè¾“å…¥è‚¡ç¥¨ä»£ç æ—¶å¯ç”¨ï¼‰
              <div
                id="fundamentalFilterSettingBtn"
                class="rounded-md border border-gray-300 text-gray-500 cursor-pointer"
              >
                <svg width="18" height="18" viewBox="0 0 20 20">
                  <path
                    d="M13 13h4-4V8H7v5h6v4-4H7V8H3h4V3v5h6V3v5h4-4v5zm-6 0v4-4H3h4z"
                    stroke="currentColor"
                    fill="none"
                    fill-rule="evenodd"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  ></path>
                </svg>
              </div>
            </h3>
          </div>

          <!-- æŒ‡æ ‡ç­›é€‰ï¼ˆåŠ¨æ€ç”Ÿæˆï¼‰ -->
          <div
            id="filterFieldsContainer"
            class="flex flex-wrap gap-6 mb-6"
          ></div>
        </div>

        <!-- è´¢æŠ¥ç­›é€‰åŒºåŸŸ -->
        <div id="fsFilter">
          <!-- ç­›é€‰æ¡ä»¶æ ‡é¢˜ -->
          <div class="mb-4">
            <h3 class="font-semibold text-gray-600 flex items-center">
              è´¢æŠ¥ç­›é€‰ï¼ˆä»…åœ¨æœªè¾“å…¥è‚¡ç¥¨ä»£ç æ—¶å¯ç”¨ï¼‰
              <div
                id="fsFilterSettingBtn"
                class="rounded-md border border-gray-300 text-gray-500 cursor-pointer"
              >
                <svg width="18" height="18" viewBox="0 0 20 20">
                  <path
                    d="M13 13h4-4V8H7v5h6v4-4H7V8H3h4V3v5h6V3v5h4-4v5zm-6 0v4-4H3h4z"
                    stroke="currentColor"
                    fill="none"
                    fill-rule="evenodd"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  ></path>
                </svg>
              </div>
            </h3>
          </div>

          <!-- è´¢æŠ¥æ—¥æœŸé€‰æ‹©å™¨ -->
          <div id="fsDateContainer" class="mb-4 hidden">
            <label
              for="fsDate"
              class="block font-medium text-sm text-gray-700 mb-2"
            >
              æŒ‡å®šè´¢æŠ¥æ—¥æœŸ
            </label>
            <input
              type="date"
              id="fsDate"
              class="w-full text-sm px-4 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-300 focus:ring-2 focus:ring-blue-200 transition-colors"
              placeholder="æŒ‡å®šè´¢æŠ¥æ—¥æœŸ"
              required
            />
          </div>

          <!-- æŒ‡æ ‡ç­›é€‰ï¼ˆåŠ¨æ€ç”Ÿæˆï¼‰ -->
          <div
            id="fsFilterFieldsContainer"
            class="flex flex-wrap gap-6 mb-6"
          ></div>

          <div class="border-t mt-5 mb-5 border-gray-200"></div>
        </div>

        <div
          id="filterConditionsDescription"
          class="text-sm text-gray-500 mb-4"
        ></div>
        <!-- æŒ‰é’®ç»„ -->
        <div class="flex gap-6">
          <button
            id="filterBtn"
            class="flex-1 px-3 py-3 text-sm text-white font-medium rounded-lg bg-gray-700 leading-5 enabled:hover:bg-gray-800 transform transition-all duration-200 tracking-widest"
          >
            ç­›é€‰
          </button>
          <button
            id="resetBtn"
            class="flex-1 px-3 py-3 text-sm font-medium rounded-lg transform transition-all duration-200 tracking-widest border-2 border-gray-200 text-gray-500 enabled:hover:text-gray-700 enabled:hover:border-gray-300"
          >
            é‡ç½®
          </button>
        </div>
      </div>

      <!-- ç»“æœåŒºåŸŸ -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex justify-between items-center mb-6">
          <h3 class="font-semibold text-gray-600">ç­›é€‰ç»“æœ</h3>
          <span
            class="text-sm font-medium text-gray-600"
            id="resultCount"
          ></span>
        </div>
        <div id="resultTable"></div>
      </div>
    </div>

    <!-- ç­›é€‰é¡¹é…ç½®å¼¹çª— -->
    <div
      id="filterConfigModal"
      class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center"
      style="display: none"
    >
      <div
        class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-hidden flex flex-col"
      >
        <!-- å¼¹çª—æ ‡é¢˜ -->
        <div class="px-6 py-4 border-b border-gray-200">
          <h2
            id="filterConfigModalTitle"
            class="text-xl font-semibold text-gray-800"
          >
            ç­›é€‰é¡¹é…ç½®
          </h2>
        </div>

        <!-- å¼¹çª—å†…å®¹ -->
        <div class="px-6 py-4 flex-1 overflow-y-auto">
          <!-- æ·»åŠ æŒ‰é’® -->
          <button
            id="addFilterFieldBtn"
            class="mb-4 w-full h-16 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center text-gray-500 hover:border-gray-400 hover:text-gray-600 transition-colors"
          >
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            <span class="ml-2">æ·»åŠ æ–°ç­›é€‰é¡¹</span>
          </button>

          <!-- åˆ†éš”çº¿ -->
          <div class="border-t border-gray-200 mb-4"></div>

          <!-- ç­›é€‰é¡¹åˆ—è¡¨ -->
          <div id="filterFieldsList" class="space-y-2">
            <!-- è¡¨å¤´ -->
            <div
              class="grid grid-cols-3 gap-4 mb-2 pb-2 border-b border-gray-200"
            >
              <div class="font-semibold text-sm text-gray-700">ç­›é€‰é¡¹åç§°</div>
              <div class="font-semibold text-sm text-gray-700">ç†æä»æŒ‡æ ‡</div>
              <div class="font-semibold text-sm text-gray-700">æ“ä½œ</div>
            </div>
            <!-- ç­›é€‰é¡¹åˆ—è¡¨é¡¹å°†åŠ¨æ€æ’å…¥è¿™é‡Œ -->
          </div>

          <!-- APIæµ‹è¯•ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
          <div id="apiTestResult" class="mt-4 hidden">
            <div class="bg-gray-100 rounded-lg p-4">
              <pre
                id="apiTestResultContent"
                class="text-xs text-gray-800 whitespace-pre-wrap break-words"
              ></pre>
            </div>
          </div>
        </div>

        <!-- å¼¹çª—åº•éƒ¨æŒ‰é’® -->
        <div
          class="px-6 py-4 border-t border-gray-200 flex justify-between items-center"
        >
          <button
            id="testApiBtn"
            class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors"
          >
            ğŸ§ª æµ‹è¯•API
          </button>
          <div class="flex gap-3">
            <button
              id="saveConfigBtn"
              class="px-4 py-2 text-sm font-medium text-white bg-gray-700 rounded-lg hover:bg-gray-800 transition-colors"
            >
              ä¿å­˜
            </button>
            <button
              id="cancelConfigBtn"
              class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
            >
              å–æ¶ˆ
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- è‚¡ç¥¨è¯„åˆ†è®¡ç®—è„šæœ¬ -->
    <script src="/static/stock-rating.js"></script>
    <!-- ç­›é€‰é¡¹é…ç½®å¼¹çª—è„šæœ¬ -->
    <script src="/static/filter-config-modal.js"></script>

    <script>
      // åŸºç¡€è°ƒè¯•ï¼Œç¡®ä¿JavaScriptæ­£å¸¸æ‰§è¡Œ
      try {
        console.log("JavaScriptå¼€å§‹æ‰§è¡Œ");
      } catch (e) {
        document.write("<h1>JavaScriptæ‰§è¡Œå‡ºé”™:</h1><p>" + e.message + "</p>");
      }

      // API è·¯å¾„é…ç½®ï¼ˆä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œå› ä¸ºå‰åç«¯åŒæºï¼‰
      const API_FILTER_URL = "/api/filter";
      const API_FILTER_CONFIG_URL = "/api/filter-config";

      // ç­›é€‰æ§ä»¶é€šç”¨é…ç½®
      const FILTER_INPUT_CONFIG = {
        step: 0.1,
        placeholderMin: "æœ€ä½",
        placeholderMax: "æœ€é«˜",
      };

      // ç­›é€‰é¡¹é…ç½®ï¼ˆç”¨äºåŠ¨æ€ç”Ÿæˆç­›é€‰æ§ä»¶ï¼‰
      // ä»åç«¯åŠ è½½çš„é…ç½®ï¼ˆåˆå§‹åŒ–ä¸ºç©ºæ•°ç»„ï¼‰
      // æš´éœ²åˆ°å…¨å±€ï¼Œä¾›å¼¹çª—æ¨¡å—ä½¿ç”¨
      let FILTER_FIELDS = [];
      let FS_FILTER_FIELDS = [];
      window.FILTER_FIELDS = FILTER_FIELDS;
      window.FS_FILTER_FIELDS = FS_FILTER_FIELDS;

      // ä»åç«¯åŠ è½½ç­›é€‰é¡¹é…ç½®
      async function loadFilterConfig() {
        try {
          console.log("æ­£åœ¨ä»åç«¯åŠ è½½ç­›é€‰é¡¹é…ç½®...");

          // åˆ†åˆ«åŠ è½½åŸºæœ¬é¢å’Œè´¢æŠ¥é…ç½®
          const [fundamentalResponse, fsResponse] = await Promise.all([
            fetch(`${API_FILTER_CONFIG_URL}?type=fundamental`),
            fetch(`${API_FILTER_CONFIG_URL}?type=fs`),
          ]);

          if (!fundamentalResponse.ok) {
            throw new Error(`HTTPé”™è¯¯!çŠ¶æ€ç : ${fundamentalResponse.status}`);
          }
          if (!fsResponse.ok) {
            throw new Error(`HTTPé”™è¯¯!çŠ¶æ€ç : ${fsResponse.status}`);
          }

          const fundamentalResult = await fundamentalResponse.json();
          const fsResult = await fsResponse.json();

          const fundamentalData = fundamentalResult.data || [];
          const fsData = fsResult.data || [];

          // ç¡®ä¿æ¯ä¸ªå­—æ®µéƒ½æœ‰ minId å’Œ maxId
          fundamentalData.forEach((field) => {
            if (!field.minId && field.key) {
              field.minId = `${field.key.trim()}Min`;
            }
            if (!field.maxId && field.key) {
              field.maxId = `${field.key.trim()}Max`;
            }
          });

          fsData.forEach((field) => {
            if (!field.minId && field.key) {
              field.minId = `${field.key.trim()}Min`;
            }
            if (!field.maxId && field.key) {
              field.maxId = `${field.key.trim()}Max`;
            }
          });

          FILTER_FIELDS = fundamentalData;
          FS_FILTER_FIELDS = fsData;
          window.FILTER_FIELDS = FILTER_FIELDS; // åŒæ­¥åˆ°å…¨å±€
          window.FS_FILTER_FIELDS = FS_FILTER_FIELDS; // åŒæ­¥åˆ°å…¨å±€
          console.log(
            `æˆåŠŸåŠ è½½ç­›é€‰é¡¹é…ç½®ï¼ŒåŸºæœ¬é¢: ${FILTER_FIELDS.length} é¡¹ï¼Œè´¢æŠ¥: ${FS_FILTER_FIELDS.length} é¡¹`
          );
        } catch (error) {
          console.error("åŠ è½½ç­›é€‰é¡¹é…ç½®å¤±è´¥:", error);
          FILTER_FIELDS = [];
          FS_FILTER_FIELDS = [];
          window.FILTER_FIELDS = FILTER_FIELDS; // åŒæ­¥åˆ°å…¨å±€
          window.FS_FILTER_FIELDS = FS_FILTER_FIELDS; // åŒæ­¥åˆ°å…¨å±€
        }
      }

      // æ¸²æŸ“å•ä¸ªåŒºé—´ç­›é€‰æ§ä»¶
      function renderRangeFilterField(field) {
        return `
          <div class="flex flex-col">
            <label for="${field.minId}" class="block font-medium text-sm text-gray-700 mb-2">
              ${field.label}
            </label>
            <div class="flex items-center text-gray-500">
              <input
                type="number"
                id="${field.minId}"
                step="${FILTER_INPUT_CONFIG.step}"
                class="md:w-[100px] w-1/2 text-sm px-4 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-300 focus:ring-2 focus:ring-blue-200 transition-colors"
                placeholder="${FILTER_INPUT_CONFIG.placeholderMin}"
              />
              <div class="mx-1">~</div>
              <input
                type="number"
                id="${field.maxId}"
                step="${FILTER_INPUT_CONFIG.step}"
                class="md:w-[100px] w-1/2 text-sm px-4 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-300 focus:ring-2 focus:ring-blue-200 transition-colors"
                placeholder="${FILTER_INPUT_CONFIG.placeholderMax}"
              />
            </div>
          </div>
        `;
      }

      // åˆå§‹åŒ–ç­›é€‰æ§ä»¶
      function initFilterFields() {
        const container = document.getElementById("filterFieldsContainer");
        if (!container) return;

        // ä»å…¨å±€å˜é‡è¯»å–é…ç½®ï¼ˆç¡®ä¿ä½¿ç”¨æœ€æ–°å€¼ï¼‰
        const fields = window.FILTER_FIELDS || FILTER_FIELDS || [];
        container.innerHTML = fields.map(renderRangeFilterField).join("");

        // ä¸ºæ‰€æœ‰ç­›é€‰è¾“å…¥æ¡†ç»‘å®š input äº‹ä»¶ï¼Œå®æ—¶æ›´æ–°ç­›é€‰æ¡ä»¶æè¿°
        fields.forEach((field) => {
          const minInput = document.getElementById(field.minId);
          const maxInput = document.getElementById(field.maxId);
          if (minInput) {
            minInput.addEventListener(
              "input",
              updateFilterConditionsDescription
            );
          }
          if (maxInput) {
            maxInput.addEventListener(
              "input",
              updateFilterConditionsDescription
            );
          }
        });

        // åˆå§‹åŒ–æ—¶æ›´æ–°ä¸€æ¬¡ç­›é€‰æ¡ä»¶æè¿°
        updateFilterConditionsDescription();
      }

      // è®¡ç®—è´¢æŠ¥é»˜è®¤æ—¥æœŸï¼ˆå‘å‰æœ€è¿‘çš„ä¸€ä¸ª12æœˆ31æ—¥ï¼Œå¦‚æœä»Šå¤©æ˜¯12æœˆ31æ—¥å°±å–ä»Šå¤©ï¼‰
      function getDefaultFsDate() {
        const today = new Date();
        const currentYear = today.getFullYear();
        const currentMonth = today.getMonth(); // 0-11
        const currentDay = today.getDate();

        // å¦‚æœä»Šå¤©æ˜¯12æœˆ31æ—¥ï¼Œè¿”å›ä»Šå¤©
        if (currentMonth === 11 && currentDay === 31) {
          return `${currentYear}-12-31`;
        }

        // å¦åˆ™è¿”å›ä¸Šä¸€ä¸ª12æœˆ31æ—¥
        // å¦‚æœå½“å‰æœˆä»½æ˜¯12æœˆä½†æ—¥æœŸä¸æ˜¯31æ—¥ï¼Œæˆ–è€…æœˆä»½å°äº12æœˆï¼Œè¿”å›å»å¹´çš„12æœˆ31æ—¥
        if (currentMonth === 11 || currentMonth < 11) {
          return `${currentYear - 1}-12-31`;
        }

        // ç†è®ºä¸Šä¸ä¼šåˆ°è¾¾è¿™é‡Œï¼Œä½†ä¸ºäº†å®‰å…¨è¿”å›å»å¹´çš„12æœˆ31æ—¥
        return `${currentYear - 1}-12-31`;
      }

      // åˆå§‹åŒ–è´¢æŠ¥ç­›é€‰æ§ä»¶
      function initFsFilterFields() {
        const container = document.getElementById("fsFilterFieldsContainer");
        if (!container) return;

        // ä»å…¨å±€å˜é‡è¯»å–é…ç½®ï¼ˆç¡®ä¿ä½¿ç”¨æœ€æ–°å€¼ï¼‰
        const fields = window.FS_FILTER_FIELDS || FS_FILTER_FIELDS || [];
        container.innerHTML = fields.map(renderRangeFilterField).join("");

        // æ§åˆ¶è´¢æŠ¥æ—¥æœŸé€‰æ‹©å™¨çš„æ˜¾ç¤º/éšè—
        const fsDateContainer = document.getElementById("fsDateContainer");
        const fsDateInput = document.getElementById("fsDate");

        if (fsDateContainer && fsDateInput) {
          if (fields.length > 0) {
            // æœ‰è´¢æŠ¥ç­›é€‰é¡¹æ—¶æ˜¾ç¤ºæ—¥æœŸé€‰æ‹©å™¨
            fsDateContainer.classList.remove("hidden");
            // è®¾ç½®é»˜è®¤æ—¥æœŸ
            if (!fsDateInput.value) {
              fsDateInput.value = getDefaultFsDate();
            }
          } else {
            // æ²¡æœ‰è´¢æŠ¥ç­›é€‰é¡¹æ—¶éšè—æ—¥æœŸé€‰æ‹©å™¨
            fsDateContainer.classList.add("hidden");
            fsDateInput.value = "";
          }
        }

        // ä¸ºæ‰€æœ‰ç­›é€‰è¾“å…¥æ¡†ç»‘å®š input äº‹ä»¶ï¼Œå®æ—¶æ›´æ–°ç­›é€‰æ¡ä»¶æè¿°
        fields.forEach((field) => {
          const minInput = document.getElementById(field.minId);
          const maxInput = document.getElementById(field.maxId);
          if (minInput) {
            minInput.addEventListener(
              "input",
              updateFilterConditionsDescription
            );
          }
          if (maxInput) {
            maxInput.addEventListener(
              "input",
              updateFilterConditionsDescription
            );
          }
        });

        // åˆå§‹åŒ–æ—¶æ›´æ–°ä¸€æ¬¡ç­›é€‰æ¡ä»¶æè¿°
        updateFilterConditionsDescription();
      }

      // æ ¹æ®è‚¡ç¥¨ä»£ç è¾“å…¥æ¡†å†…å®¹ï¼Œç¦ç”¨/å¯ç”¨ç­›é€‰æ§ä»¶
      function updateFilterControlsState() {
        const stockCodeInput = document.getElementById("stockCode");
        const fundamentalContainer = document.getElementById(
          "filterFieldsContainer"
        );
        const fsContainer = document.getElementById("fsFilterFieldsContainer");
        const filterBtn = document.getElementById("filterBtn");
        const resetBtn = document.getElementById("resetBtn");
        if (!stockCodeInput) return;

        const hasStockCode = stockCodeInput.value.trim().length > 0;

        // å¤„ç†åŸºæœ¬é¢ç­›é€‰æ§ä»¶
        if (fundamentalContainer) {
          const inputs = fundamentalContainer.querySelectorAll(
            'input[type="number"]'
          );
          inputs.forEach((input) => {
            input.disabled = hasStockCode;
            if (hasStockCode) {
              input.classList.add(
                "bg-gray-100",
                "cursor-not-allowed",
                "opacity-60"
              );
            } else {
              input.classList.remove(
                "bg-gray-100",
                "cursor-not-allowed",
                "opacity-60"
              );
            }
          });
        }

        // å¤„ç†è´¢æŠ¥ç­›é€‰æ§ä»¶
        if (fsContainer) {
          const inputs = fsContainer.querySelectorAll('input[type="number"]');
          inputs.forEach((input) => {
            input.disabled = hasStockCode;
            if (hasStockCode) {
              input.classList.add(
                "bg-gray-100",
                "cursor-not-allowed",
                "opacity-60"
              );
            } else {
              input.classList.remove(
                "bg-gray-100",
                "cursor-not-allowed",
                "opacity-60"
              );
            }
          });
        }

        // å¤„ç†è´¢æŠ¥æ—¥æœŸé€‰æ‹©å™¨
        const fsDateInput = document.getElementById("fsDate");
        if (fsDateInput) {
          fsDateInput.disabled = hasStockCode;
          if (hasStockCode) {
            fsDateInput.classList.add(
              "bg-gray-100",
              "cursor-not-allowed",
              "opacity-60"
            );
          } else {
            fsDateInput.classList.remove(
              "bg-gray-100",
              "cursor-not-allowed",
              "opacity-60"
            );
          }
        }

        // å½“è‚¡ç¥¨ä»£ç æœ‰å†…å®¹æ—¶ï¼Œç¦ç”¨ç­›é€‰å’Œé‡ç½®æŒ‰é’®
        if (filterBtn) {
          filterBtn.disabled = hasStockCode;
          if (hasStockCode) {
            filterBtn.classList.add("cursor-not-allowed", "opacity-60");
          } else {
            filterBtn.classList.remove("cursor-not-allowed", "opacity-60");
          }
        }
        if (resetBtn) {
          resetBtn.disabled = hasStockCode;
          if (hasStockCode) {
            resetBtn.classList.add("cursor-not-allowed", "opacity-60");
          } else {
            resetBtn.classList.remove("cursor-not-allowed", "opacity-60");
          }
        }
      }

      // ç›‘å¬ç­›é€‰é¡¹é…ç½®æ›´æ–°äº‹ä»¶ï¼ˆåœ¨ DOMContentLoaded ä¹‹å‰æ³¨å†Œï¼Œç¡®ä¿èƒ½æ•è·äº‹ä»¶ï¼‰
      function handleFilterConfigUpdated(event) {
        console.log("ç­›é€‰é¡¹é…ç½®å·²æ›´æ–°ï¼Œé‡æ–°åˆå§‹åŒ–ç­›é€‰æ§ä»¶", event);
        // æ›´æ–°å…¨å±€ FILTER_FIELDS å˜é‡
        if (event.detail && event.detail.config) {
          const configType = event.detail.type || "fundamental";
          if (configType === "fundamental") {
            FILTER_FIELDS = event.detail.config;
            window.FILTER_FIELDS = FILTER_FIELDS; // åŒæ­¥åˆ°å…¨å±€
            console.log("å·²æ›´æ–° FILTER_FIELDS:", FILTER_FIELDS);
            // é‡æ–°åˆå§‹åŒ–ç­›é€‰æ§ä»¶
            initFilterFields();
            // æ›´æ–°ç­›é€‰æ¡ä»¶æè¿°
            updateFilterConditionsDescription();
          } else if (configType === "fs") {
            FS_FILTER_FIELDS = event.detail.config;
            window.FS_FILTER_FIELDS = FS_FILTER_FIELDS; // åŒæ­¥åˆ°å…¨å±€
            console.log("å·²æ›´æ–° FS_FILTER_FIELDS:", FS_FILTER_FIELDS);
            // é‡æ–°åˆå§‹åŒ–è´¢æŠ¥ç­›é€‰æ§ä»¶
            initFsFilterFields();
            // æ›´æ–°ç­›é€‰æ¡ä»¶æè¿°
            updateFilterConditionsDescription();
          }
        }
      }

      // ç«‹å³æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨ï¼ˆä¸ç­‰å¾… DOMContentLoadedï¼‰
      document.addEventListener(
        "filterConfigUpdated",
        handleFilterConfigUpdated
      );
      // åŒæ—¶ä¹Ÿç›‘å¬ window å¯¹è±¡ä¸Šçš„äº‹ä»¶ï¼ˆåŒé‡ä¿é™©ï¼‰
      window.addEventListener("filterConfigUpdated", handleFilterConfigUpdated);

      // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
      try {
        document.addEventListener("DOMContentLoaded", async () => {
          console.log("DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–é¡µé¢");

          // å…ˆåŠ è½½ç­›é€‰é¡¹é…ç½®
          await loadFilterConfig();

          // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
          const today = new Date().toISOString().split("T")[0];
          document.getElementById("date").value = today;
          console.log("è®¾ç½®é»˜è®¤æ—¥æœŸä¸º:", today);

          // ç»‘å®šæŒ‰é’®äº‹ä»¶
          const filterBtn = document.getElementById("filterBtn");
          const resetBtn = document.getElementById("resetBtn");
          const stockCodeInput = document.getElementById("stockCode");
          const searchStockCodeBtn =
            document.getElementById("searchStockCodeBtn");

          if (filterBtn && resetBtn) {
            filterBtn.addEventListener("click", handleFilter);
            resetBtn.addEventListener("click", handleReset);
            console.log("æŒ‰é’®äº‹ä»¶ç»‘å®šå®Œæˆ");
          } else {
            console.error("æ‰¾ä¸åˆ°æŒ‰é’®å…ƒç´ ");
          }

          // è‚¡ç¥¨ä»£ç è¾“å…¥æ—¶æ›´æ–°åŸºæœ¬é¢ç­›é€‰çŠ¶æ€
          if (stockCodeInput) {
            stockCodeInput.addEventListener("input", () => {
              updateFilterControlsState();
              updateFilterConditionsDescription();
            });
            // åœ¨è¾“å…¥æ¡†ä¸­æŒ‰å›è½¦æ—¶è§¦å‘ç­›é€‰
            stockCodeInput.addEventListener("keydown", (event) => {
              if (event.key === "Enter") {
                event.preventDefault();
                // å›è½¦åè®©è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹
                stockCodeInput.blur();
                handleFilter();
              }
            });
          }

          // ç‚¹å‡»æ”¾å¤§é•œå›¾æ ‡æ—¶ï¼Œè§¦å‘æŸ¥è¯¢
          if (searchStockCodeBtn) {
            searchStockCodeBtn.addEventListener("click", () => {
              handleFilter();
            });
          }

          // åŠ¨æ€æ¸²æŸ“ç­›é€‰æ§ä»¶
          initFilterFields();
          initFsFilterFields();

          // åˆå§‹åŒ–ä¸€æ¬¡çŠ¶æ€
          updateFilterControlsState();
        });
      } catch (e) {
        console.error("é¡µé¢åˆå§‹åŒ–å¤±è´¥:", e);
      }

      // æ·»åŠ è¯·æ±‚èŠ‚æµæ§åˆ¶
      let isRequesting = false;

      // åˆ‡æ¢æ•´é¡µè¡¨å•çš„å¯ç”¨/ç¦ç”¨çŠ¶æ€
      function setUIBusy(isBusy) {
        const root = document;
        const inputs = root.querySelectorAll("input, select, textarea");
        const buttons = root.querySelectorAll("button");

        inputs.forEach((el) => {
          if (el.id === "stockCode") {
            // è‚¡ç¥¨ä»£ç è¾“å…¥æ¡†ä¹Ÿä¸€èµ·ç¦ç”¨
            el.disabled = isBusy;
          } else {
            el.disabled = isBusy;
          }
          if (isBusy) {
            el.classList.add("cursor-not-allowed", "opacity-60");
          } else {
            el.classList.remove("cursor-not-allowed", "opacity-60");
          }
        });

        buttons.forEach((btn) => {
          btn.disabled = isBusy;
          if (isBusy) {
            btn.classList.add("cursor-not-allowed", "opacity-60");
          } else {
            btn.classList.remove("cursor-not-allowed", "opacity-60");
          }
        });
      }

      // ç­›é€‰æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      async function handleFilter() {
        console.log("ç­›é€‰æŒ‰é’®è¢«ç‚¹å‡»");

        // æ£€æŸ¥æ˜¯å¦æ­£åœ¨è¯·æ±‚ä¸­
        if (isRequesting) {
          alert("è¯·æ±‚æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™å†è¯•");
          return;
        }

        // å…ˆè¿›è¡Œæ‰€æœ‰éªŒè¯æ£€æŸ¥ï¼Œå†è®¾ç½®è¯·æ±‚çŠ¶æ€
        const stockCode = document.getElementById("stockCode").value.trim();
        const date = document.getElementById("date").value;

        // éªŒè¯æ—¥æœŸæ˜¯å¦å¡«å†™
        if (!date) {
          alert("è¯·é€‰æ‹©æŒ‡å®šæ—¥æœŸ");
          return;
        }

        // æ£€æŸ¥æ˜¯å¦æœ‰è´¢æŠ¥ç­›é€‰æ¡ä»¶
        const hasFsFilter = checkHasFsFilterConditions();
        if (hasFsFilter) {
          const fsDate = document.getElementById("fsDate").value;
          if (!fsDate) {
            alert("è¯·é€‰æ‹©æŒ‡å®šè´¢æŠ¥æ—¥æœŸ");
            return;
          }
        }

        // å¦‚æœæ²¡æœ‰è‚¡ç¥¨ä»£ç ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰ç­›é€‰æ¡ä»¶
        if (!stockCode) {
          const hasFilter = checkHasFilterConditions();
          const hasFsFilterConditions = checkHasFsFilterConditions();
          if (!hasFilter && !hasFsFilterConditions) {
            alert("è¯·è‡³å°‘è¾“å…¥ä¸€ä¸ªç­›é€‰æ¡ä»¶");
            return;
          }
        }

        // æ‰€æœ‰éªŒè¯é€šè¿‡åï¼Œè®¾ç½®è¯·æ±‚çŠ¶æ€
        try {
          isRequesting = true;
          setUIBusy(true);

          // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
          showLoading();

          let stockData = [];

          // åˆ¤æ–­ä½¿ç”¨å“ªä¸ªæ¥å£
          if (stockCode) {
            // æ¥å£ä¸€ï¼šè·å–æŒ‡å®šè‚¡ç¥¨çš„ä¿¡æ¯
            console.log("ä½¿ç”¨æ¥å£ä¸€ï¼šè·å–æŒ‡å®šè‚¡ç¥¨æ•°æ®");
            // å¦‚æœæœ‰è´¢æŠ¥ç­›é€‰é¡¹é…ç½®ï¼Œä½¿ç”¨è´¢æŠ¥æ—¥æœŸï¼›å¦åˆ™ä¸ä¼ é€’è´¢æŠ¥æ—¥æœŸï¼ˆä½¿ç”¨åŸºç¡€æ—¥æœŸï¼‰
            const fsFields = window.FS_FILTER_FIELDS || FS_FILTER_FIELDS || [];
            const fsDateInput = document.getElementById("fsDate");
            const fsDate =
              fsFields.length > 0 && fsDateInput && fsDateInput.value
                ? fsDateInput.value
                : null;
            stockData = await fetchStockData([stockCode], date, fsDate);
          } else {
            // æ¥å£äºŒï¼šæ ¹æ®ç­›é€‰æ¡ä»¶ç­›é€‰è‚¡ç¥¨
            console.log("ä½¿ç”¨æ¥å£äºŒï¼šç­›é€‰è‚¡ç¥¨");
            // è·å–è´¢æŠ¥æ—¥æœŸï¼ˆå¦‚æœæœ‰è´¢æŠ¥ç­›é€‰æ¡ä»¶ï¼‰
            const fsFields = window.FS_FILTER_FIELDS || FS_FILTER_FIELDS || [];
            const fsDateInput = document.getElementById("fsDate");
            const fsDate =
              fsFields.length > 0 && fsDateInput && fsDateInput.value
                ? fsDateInput.value
                : null;
            stockData = await filterStocksByMetrics(date, fsDate);
          }

          console.log("è·å–åˆ°çš„è‚¡ç¥¨æ•°æ®:", stockData);

          // è®¡ç®—è¯„åˆ†
          const stocksWithRating = calculateRating(stockData);

          // æ˜¾ç¤ºç»“æœ
          displayResults(stocksWithRating);
        } catch (error) {
          console.error("æ“ä½œå¤±è´¥:", error);

          // é’ˆå¯¹ä¸åŒé”™è¯¯ç±»å‹æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯æ¶ˆæ¯
          if (error.message.includes("ç¼ºå°‘ç­›é€‰æ¡ä»¶")) {
            // è¿™ä¸ªé”™è¯¯å·²ç»åœ¨è°ƒç”¨å‰æ£€æŸ¥è¿‡äº†ï¼Œä¸åº”è¯¥åˆ°è¾¾è¿™é‡Œï¼Œä½†ä½œä¸ºé˜²å¾¡æ€§å¤„ç†
            // ä¸æ˜¾ç¤º alertï¼Œå› ä¸ºå·²ç»åœ¨è°ƒç”¨å‰æ˜¾ç¤ºè¿‡äº†
          } else if (error.message.includes("429")) {
            alert(
              "è¯·æ±‚æ¬¡æ•°è¿‡å¤šï¼Œè¯·ç¨åå†è¯•ã€‚\n\nå»ºè®®ï¼š\n1. å‡å°‘åŒæ—¶æŸ¥è¯¢çš„è‚¡ç¥¨æ•°é‡\n2. å»¶é•¿ä¸¤æ¬¡æŸ¥è¯¢ä¹‹é—´çš„æ—¶é—´é—´éš”"
            );
          } else {
            alert(`æ“ä½œå¤±è´¥: ${error.message}`);
          }

          showNoResults();
        } finally {
          isRequesting = false;
          console.log("è¯·æ±‚çŠ¶æ€é‡ç½®ï¼Œå¯ä»¥å‘èµ·æ–°è¯·æ±‚");
          setUIBusy(false);
          // æ ¹æ®å½“å‰è‚¡ç¥¨ä»£ç è¾“å…¥å†…å®¹ï¼Œæ¢å¤ç­›é€‰åŒºåŸŸåº”æœ‰çš„ç¦ç”¨çŠ¶æ€
          updateFilterControlsState();
        }
      }

      // é‡ç½®æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      function handleReset() {
        document.getElementById("stockCode").value = "";

        // é‡ç½®åŸºæœ¬é¢ç­›é€‰å­—æ®µ
        const fundamentalFields = window.FILTER_FIELDS || FILTER_FIELDS || [];
        fundamentalFields.forEach((field) => {
          if (field.minId) {
            const minInput = document.getElementById(field.minId);
            if (minInput) minInput.value = "";
          }
          if (field.maxId) {
            const maxInput = document.getElementById(field.maxId);
            if (maxInput) maxInput.value = "";
          }
        });

        // é‡ç½®è´¢æŠ¥ç­›é€‰å­—æ®µ
        const fsFields = window.FS_FILTER_FIELDS || FS_FILTER_FIELDS || [];
        fsFields.forEach((field) => {
          if (field.minId) {
            const minInput = document.getElementById(field.minId);
            if (minInput) minInput.value = "";
          }
          if (field.maxId) {
            const maxInput = document.getElementById(field.maxId);
            if (maxInput) maxInput.value = "";
          }
        });

        document.getElementById("date").value = new Date()
          .toISOString()
          .split("T")[0];

        // é‡ç½®è´¢æŠ¥æ—¥æœŸï¼ˆå¦‚æœæœ‰è´¢æŠ¥ç­›é€‰é¡¹ï¼Œè®¾ç½®ä¸ºé»˜è®¤æ—¥æœŸï¼‰
        const fsDateInput = document.getElementById("fsDate");
        if (fsDateInput && fsFields.length > 0) {
          fsDateInput.value = getDefaultFsDate();
        } else if (fsDateInput) {
          fsDateInput.value = "";
        }

        // æ›´æ–°ç­›é€‰æ§ä»¶çš„ç¦ç”¨çŠ¶æ€ï¼ˆå› ä¸ºè‚¡ç¥¨ä»£ç å·²æ¸…ç©ºï¼Œåº”è¯¥å¯ç”¨ç­›é€‰ï¼‰
        updateFilterControlsState();

        // æ›´æ–°ç­›é€‰æ¡ä»¶æè¿°
        updateFilterConditionsDescription();

        // æ³¨æ„ï¼šä¸æ¸…ç©ºç­›é€‰ç»“æœï¼Œä¿ç•™å½“å‰æ˜¾ç¤ºçš„æ•°æ®
      }

      // ä»åµŒå¥—å¯¹è±¡ä¸­æå–å­—æ®µå€¼ï¼ˆç”¨äºè´¢æŠ¥æ•°æ®ï¼‰
      // ä¾‹å¦‚ï¼šå­—æ®µ "y.m.roe.t" ä» {y: {m: {roe: {t: 0.2038}}}} ä¸­æå– 0.2038
      function extractNestedFieldValue(obj, fieldKey) {
        if (!obj || !fieldKey) return null;

        const keys = fieldKey.split(".");
        let value = obj;

        for (const key of keys) {
          if (value && typeof value === "object" && key in value) {
            value = value[key];
          } else {
            return null;
          }
        }

        return value;
      }

      // å¤„ç†è´¢æŠ¥æ•°æ®ï¼Œæå–åµŒå¥—å­—æ®µå€¼åˆ°é¡¶å±‚
      function processFsData(fsData, fsFields) {
        if (!fsData || !fsFields || fsFields.length === 0) {
          return fsData;
        }

        // è·å–æ‰€æœ‰è´¢æŠ¥å­—æ®µçš„key
        const fsMetrics = fsFields.map((field) => field.key).filter(Boolean);

        // åˆ›å»ºæ–°å¯¹è±¡ï¼ŒåŒ…å«åŸå§‹æ•°æ®å’Œæå–çš„å­—æ®µå€¼
        const processedData = { ...fsData };

        // æå–æ¯ä¸ªå­—æ®µçš„å€¼
        fsMetrics.forEach((fieldKey) => {
          const value = extractNestedFieldValue(fsData, fieldKey);
          if (value !== null && value !== undefined) {
            processedData[fieldKey] = value;
          }
        });

        return processedData;
      }

      // æ¥å£ä¸€ï¼šè·å–æŒ‡å®šè‚¡ç¥¨çš„åŸºæœ¬é¢æ•°æ®
      async function fetchStockData(stockCodes, date, fsDate) {
        try {
          console.log("è°ƒç”¨æ¥å£ä¸€ï¼šè·å–æŒ‡å®šè‚¡ç¥¨æ•°æ®ï¼ˆåŸºæœ¬é¢+è´¢æŠ¥ï¼‰");

          // ä»é…ç½®ä¸­æå– metricsList
          const fundamentalFields = window.FILTER_FIELDS || FILTER_FIELDS || [];
          const fsFields = window.FS_FILTER_FIELDS || FS_FILTER_FIELDS || [];

          const fundamentalMetrics = fundamentalFields
            .map((field) => field.key)
            .filter(Boolean);
          const fsMetrics = fsFields.map((field) => field.key).filter(Boolean);

          if (fundamentalMetrics.length === 0 && fsMetrics.length === 0) {
            throw new Error("æ²¡æœ‰é…ç½®ç­›é€‰é¡¹ï¼Œè¯·å…ˆé…ç½®ç­›é€‰é¡¹");
          }

          // ä½¿ç”¨æ–°çš„å¯¹è±¡æ ¼å¼ï¼šfundamental å’Œ fs
          const metricsList = {
            fundamental: fundamentalMetrics,
            fs: fsMetrics,
          };

          const requestData = {
            stockCodes: stockCodes,
            metricsList: metricsList,
            date: date,
          };

          // å¦‚æœæœ‰è´¢æŠ¥æ—¥æœŸï¼Œæ·»åŠ åˆ°è¯·æ±‚ä¸­
          if (fsDate) {
            requestData.fsDate = fsDate;
          }

          const response = await fetch(API_FILTER_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(requestData),
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(
              errorData.error || `HTTPé”™è¯¯!çŠ¶æ€ç : ${response.status}`
            );
          }

          const result = await response.json();
          console.log("æ¥å£ä¸€è¿”å›çš„æ•°æ®:", result);

          // å¤„ç†æ–°çš„è¿”å›æ ¼å¼ï¼š{fundamental: {...}, fs: {...}}
          // åˆå¹¶fundamentalå’Œfsçš„æ•°æ®ï¼Œä¼˜å…ˆä½¿ç”¨fundamentalçš„æ•°æ®
          let stockData = [];
          if (result.fundamental && result.fundamental.data) {
            stockData = result.fundamental.data;
            // å¦‚æœæœ‰fsæ•°æ®ï¼Œåˆå¹¶åˆ°stockDataä¸­
            if (result.fs && result.fs.data && result.fs.data.length > 0) {
              // æŒ‰stockCodeåˆå¹¶æ•°æ®
              const fsDataMap = {};
              result.fs.data.forEach((stock) => {
                // å¤„ç†è´¢æŠ¥æ•°æ®ï¼Œæå–åµŒå¥—å­—æ®µå€¼
                const processedFsData = processFsData(stock, fsFields);
                fsDataMap[stock.stockCode] = processedFsData;
              });

              stockData = stockData.map((stock) => {
                const fsData = fsDataMap[stock.stockCode];
                if (fsData) {
                  // åˆå¹¶fsæ•°æ®åˆ°stockå¯¹è±¡ä¸­
                  return { ...stock, ...fsData };
                }
                return stock;
              });
            }
          } else if (result.fs && result.fs.data) {
            // å¦‚æœåªæœ‰fsæ•°æ®ï¼Œå¤„ç†è´¢æŠ¥æ•°æ®
            stockData = result.fs.data.map((stock) => {
              return processFsData(stock, fsFields);
            });
          } else if (result.data) {
            // å‘åå…¼å®¹ï¼šå¦‚æœè¿”å›çš„æ˜¯æ—§æ ¼å¼
            stockData = result.data;
          }

          return stockData;
        } catch (error) {
          console.error("è·å–è‚¡ç¥¨æ•°æ®å¤±è´¥:", error);
          throw error;
        }
      }

      // æ£€æŸ¥æ˜¯å¦æœ‰ç­›é€‰æ¡ä»¶
      function checkHasFilterConditions() {
        const fields = window.FILTER_FIELDS || FILTER_FIELDS || [];

        for (const field of fields) {
          if (!field.minId || !field.maxId) continue;

          const minInput = document.getElementById(field.minId);
          const maxInput = document.getElementById(field.maxId);

          if (!minInput || !maxInput) continue;

          const minValue = parseFloat(minInput.value);
          const maxValue = parseFloat(maxInput.value);

          if (!isNaN(minValue) || !isNaN(maxValue)) {
            return true;
          }
        }

        return false;
      }

      // æ£€æŸ¥æ˜¯å¦æœ‰è´¢æŠ¥ç­›é€‰æ¡ä»¶
      function checkHasFsFilterConditions() {
        const fields = window.FS_FILTER_FIELDS || FS_FILTER_FIELDS || [];

        for (const field of fields) {
          if (!field.minId || !field.maxId) continue;

          const minInput = document.getElementById(field.minId);
          const maxInput = document.getElementById(field.maxId);

          if (!minInput || !maxInput) continue;

          const minValue = parseFloat(minInput.value);
          const maxValue = parseFloat(maxInput.value);

          if (!isNaN(minValue) || !isNaN(maxValue)) {
            return true;
          }
        }

        return false;
      }

      // æ¥å£äºŒï¼šæ ¹æ®ç­›é€‰æ¡ä»¶ç­›é€‰è‚¡ç¥¨
      async function filterStocksByMetrics(date, fsDate) {
        try {
          console.log("è°ƒç”¨æ¥å£äºŒï¼šæ ¹æ®ç­›é€‰æ¡ä»¶ç­›é€‰è‚¡ç¥¨");

          // ä»é…ç½®ä¸­æå–åŸºæœ¬é¢ metricsList
          const fields = window.FILTER_FIELDS || FILTER_FIELDS || [];
          const metricsList = fields.map((field) => field.key).filter(Boolean);

          // ä»é…ç½®ä¸­æå–è´¢æŠ¥ metricsList
          const fsFields = window.FS_FILTER_FIELDS || FS_FILTER_FIELDS || [];
          const fsMetricsList = fsFields
            .map((field) => field.key)
            .filter(Boolean);

          if (metricsList.length === 0 && fsMetricsList.length === 0) {
            throw new Error("æ²¡æœ‰é…ç½®ç­›é€‰é¡¹ï¼Œè¯·å…ˆé…ç½®ç­›é€‰é¡¹");
          }

          // æ„å»ºåŸºæœ¬é¢ metricsFilter å¯¹è±¡ï¼ˆåŠ¨æ€ä»é…ç½®ä¸­è¯»å–ï¼‰
          const metricsFilter = {};

          fields.forEach((field) => {
            if (!field.key || !field.minId || !field.maxId) return;

            const minInput = document.getElementById(field.minId);
            const maxInput = document.getElementById(field.maxId);

            if (!minInput || !maxInput) return;

            const minValue = parseFloat(minInput.value);
            const maxValue = parseFloat(maxInput.value);

            // å¦‚æœè‡³å°‘æœ‰ä¸€ä¸ªå€¼æœ‰æ•ˆï¼Œåˆ™æ·»åŠ åˆ°ç­›é€‰æ¡ä»¶ä¸­
            if (!isNaN(minValue) || !isNaN(maxValue)) {
              // æ£€æŸ¥labelæ˜¯å¦åŒ…å«"ä¸‡å…ƒ"æˆ–"ä¸‡"ï¼Œå¦‚æœåŒ…å«åˆ™éœ€è¦å•ä½è½¬æ¢ï¼ˆä¸‡å…ƒè½¬å…ƒï¼‰
              const label = field.label || field.key;
              const needsConversion =
                label.includes("ä¸‡å…ƒ") ||
                label.includes("ä¸‡") ||
                field.key === "mc";

              if (needsConversion) {
                metricsFilter[field.key] = [
                  !isNaN(minValue) ? minValue * 10000 : null, // ä¸‡å…ƒè½¬å…ƒ
                  !isNaN(maxValue) ? maxValue * 10000 : null,
                ];
              } else {
                metricsFilter[field.key] = [
                  !isNaN(minValue) ? minValue : null,
                  !isNaN(maxValue) ? maxValue : null,
                ];
              }
            }
          });

          // æ„å»ºè´¢æŠ¥ metricsFilter å¯¹è±¡ï¼ˆåŠ¨æ€ä»é…ç½®ä¸­è¯»å–ï¼‰
          const fsMetricsFilter = {};

          fsFields.forEach((field) => {
            if (!field.key || !field.minId || !field.maxId) return;

            const minInput = document.getElementById(field.minId);
            const maxInput = document.getElementById(field.maxId);

            if (!minInput || !maxInput) return;

            const minValue = parseFloat(minInput.value);
            const maxValue = parseFloat(maxInput.value);

            // å¦‚æœè‡³å°‘æœ‰ä¸€ä¸ªå€¼æœ‰æ•ˆï¼Œåˆ™æ·»åŠ åˆ°ç­›é€‰æ¡ä»¶ä¸­
            if (!isNaN(minValue) || !isNaN(maxValue)) {
              // æ£€æŸ¥labelæ˜¯å¦åŒ…å«"ä¸‡å…ƒ"æˆ–"ä¸‡"ï¼Œå¦‚æœåŒ…å«åˆ™éœ€è¦å•ä½è½¬æ¢ï¼ˆä¸‡å…ƒè½¬å…ƒï¼‰
              const label = field.label || field.key;
              const needsConversion =
                label.includes("ä¸‡å…ƒ") ||
                label.includes("ä¸‡") ||
                field.key === "mc";

              if (needsConversion) {
                fsMetricsFilter[field.key] = [
                  !isNaN(minValue) ? minValue * 10000 : null, // ä¸‡å…ƒè½¬å…ƒ
                  !isNaN(maxValue) ? maxValue * 10000 : null,
                ];
              } else {
                fsMetricsFilter[field.key] = [
                  !isNaN(minValue) ? minValue : null,
                  !isNaN(maxValue) ? maxValue : null,
                ];
              }
            }
          });

          // æ£€æŸ¥æ˜¯å¦æœ‰ç­›é€‰æ¡ä»¶ï¼ˆè¿™ä¸ªæ£€æŸ¥å·²ç»åœ¨è°ƒç”¨å‰å®Œæˆï¼Œè¿™é‡Œåªä½œä¸ºé˜²å¾¡æ€§æ£€æŸ¥ï¼‰
          if (
            Object.keys(metricsFilter).length === 0 &&
            Object.keys(fsMetricsFilter).length === 0
          ) {
            throw new Error("ç¼ºå°‘ç­›é€‰æ¡ä»¶");
          }

          const requestData = {
            metricsFilter: metricsFilter,
            metricsList: metricsList,
            date: date,
          };

          // å¦‚æœæœ‰è´¢æŠ¥ç­›é€‰é¡¹é…ç½®ï¼Œæ·»åŠ åˆ°è¯·æ±‚ä¸­ï¼ˆå³ä½¿æ²¡æœ‰å¡«å†™ç­›é€‰å€¼ï¼‰
          if (fsMetricsList.length > 0) {
            requestData.fsMetricsList = fsMetricsList;
            if (fsDate) {
              requestData.fsDate = fsDate;
            }
            // å¦‚æœæœ‰è´¢æŠ¥ç­›é€‰æ¡ä»¶ï¼Œä¹Ÿæ·»åŠ åˆ°è¯·æ±‚ä¸­
            if (Object.keys(fsMetricsFilter).length > 0) {
              requestData.fsMetricsFilter = fsMetricsFilter;
            }
          }

          console.log("å‘é€ç­›é€‰è¯·æ±‚:", requestData);

          const response = await fetch(API_FILTER_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(requestData),
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(
              errorData.error || `HTTPé”™è¯¯!çŠ¶æ€ç : ${response.status}`
            );
          }

          const result = await response.json();
          console.log("æ¥å£äºŒè¿”å›çš„æ•°æ®:", result);

          // å¤„ç†è´¢æŠ¥æ•°æ®çš„åµŒå¥—å­—æ®µæå–
          let stockData = result.data || [];
          if (stockData.length > 0 && fsMetricsList.length > 0) {
            stockData = stockData.map((stock) => {
              return processFsData(stock, fsFields);
            });
          }

          // è¿”å›ç­›é€‰åçš„è‚¡ç¥¨æ•°æ®
          return stockData;
        } catch (error) {
          console.error("ç­›é€‰è‚¡ç¥¨å¤±è´¥:", error);
          throw error;
        }
      }

      // è®¡ç®—è¯„åˆ†å‡½æ•°å·²ç§»è‡³ /static/stock-rating.js

      // æ›´æ–°ç­›é€‰æ¡ä»¶æè¿°ï¼ˆå®æ—¶é¢„è§ˆï¼‰
      function updateFilterConditionsDescription() {
        const descriptionElement = document.getElementById(
          "filterConditionsDescription"
        );
        if (!descriptionElement) return;

        const stockCodeInput = document.getElementById("stockCode");
        const hasStockCode =
          (stockCodeInput ? stockCodeInput.value.trim() : "").length !== 0;
        if (hasStockCode) {
          descriptionElement.textContent = "";
          descriptionElement.style.display = "none";
          return;
        }

        // æ„å»ºç­›é€‰æ¡ä»¶æè¿°
        const conditions = [];

        // å¤„ç†åŸºæœ¬é¢ç­›é€‰å­—æ®µ
        const fundamentalFields = window.FILTER_FIELDS || FILTER_FIELDS || [];
        fundamentalFields.forEach((field) => {
          if (!field.minId || !field.maxId) return;

          const minInput = document.getElementById(field.minId);
          const maxInput = document.getElementById(field.maxId);

          // å¦‚æœå…ƒç´ ä¸å­˜åœ¨ï¼Œè·³è¿‡
          if (!minInput && !maxInput) return;

          const minValue = minInput ? parseFloat(minInput.value) : NaN;
          const maxValue = maxInput ? parseFloat(maxInput.value) : NaN;

          // å¦‚æœè‡³å°‘æœ‰ä¸€ä¸ªå€¼ï¼Œæ„å»ºæ¡ä»¶æè¿°
          if (!isNaN(minValue) || !isNaN(maxValue)) {
            let condition = field.label || field.key;
            if (!isNaN(minValue) && !isNaN(maxValue)) {
              condition += ` ${minValue} ~ ${maxValue}`;
            } else if (!isNaN(minValue)) {
              condition += ` â‰¥ ${minValue}`;
            } else {
              condition += ` â‰¤ ${maxValue}`;
            }
            conditions.push(condition);
          }
        });

        // å¤„ç†è´¢æŠ¥ç­›é€‰å­—æ®µ
        const fsFields = window.FS_FILTER_FIELDS || FS_FILTER_FIELDS || [];
        fsFields.forEach((field) => {
          if (!field.minId || !field.maxId) return;

          const minInput = document.getElementById(field.minId);
          const maxInput = document.getElementById(field.maxId);

          // å¦‚æœå…ƒç´ ä¸å­˜åœ¨ï¼Œè·³è¿‡
          if (!minInput && !maxInput) return;

          const minValue = minInput ? parseFloat(minInput.value) : NaN;
          const maxValue = maxInput ? parseFloat(maxInput.value) : NaN;

          // å¦‚æœè‡³å°‘æœ‰ä¸€ä¸ªå€¼ï¼Œæ„å»ºæ¡ä»¶æè¿°
          if (!isNaN(minValue) || !isNaN(maxValue)) {
            let condition = field.label || field.key;
            if (!isNaN(minValue) && !isNaN(maxValue)) {
              condition += ` ${minValue} ~ ${maxValue}`;
            } else if (!isNaN(minValue)) {
              condition += ` â‰¥ ${minValue}`;
            } else {
              condition += ` â‰¤ ${maxValue}`;
            }
            conditions.push(condition);
          }
        });

        // è·å–æ—¥æœŸä¿¡æ¯
        const dateInput = document.getElementById("date");
        const fsDateInput = document.getElementById("fsDate");
        const otherDataDate = dateInput ? dateInput.value : "";

        // è·å–è´¢æŠ¥æ—¥æœŸï¼ˆå¦‚æœæœ‰è´¢æŠ¥ç­›é€‰æ¡ä»¶ï¼‰
        const hasFsFilterConditions = checkHasFsFilterConditions();
        const fsDate =
          hasFsFilterConditions && fsDateInput ? fsDateInput.value : "";

        // æ›´æ–°æ˜¾ç¤º
        if (conditions.length > 0) {
          let descriptionText = `ç­›é€‰æ¡ä»¶ï¼š${conditions.join("ï¼Œ")}`;

          // æ·»åŠ æ—¥æœŸä¿¡æ¯ï¼ˆæ€»æ˜¯æ˜¾ç¤ºä¸¤ä¸ªæ—¥æœŸï¼‰
          const dateInfo = [];
          dateInfo.push(`è´¢æŠ¥æ—¥æœŸï¼š${fsDate || "æœªè®¾ç½®"}`);
          dateInfo.push(`å…¶ä»–æ•°æ®æ—¥æœŸï¼š${otherDataDate || "æœªè®¾ç½®"}`);

          descriptionText += `<br>${dateInfo.join("ï¼Œ")}`;

          descriptionElement.innerHTML = descriptionText;
          descriptionElement.style.display = "block";
        } else {
          descriptionElement.innerHTML = "";
          descriptionElement.style.display = "none";
        }
      }

      // æ˜¾ç¤ºç»“æœ
      function displayResults(stocks) {
        const container = document.getElementById("resultTable");
        const countElement = document.getElementById("resultCount");

        countElement.textContent = `å…± ${stocks.length} æ¡ç»“æœ`;

        if (stocks.length === 0) {
          showNoResults();
          return;
        }

        // è·å–å­—æ®µé…ç½®æ˜ å°„ï¼ˆåŒ…æ‹¬åŸºæœ¬é¢å’Œè´¢æŠ¥ï¼‰
        const fundamentalFields = window.FILTER_FIELDS || FILTER_FIELDS || [];
        const fsFields = window.FS_FILTER_FIELDS || FS_FILTER_FIELDS || [];
        const allFields = [...fundamentalFields, ...fsFields];

        const fieldMap = {};
        allFields.forEach((field) => {
          if (field.key) {
            fieldMap[field.key] = field.label || field.key;
          }
        });

        // ä»é…ç½®ä¸­è·å–æ‰€æœ‰å­—æ®µï¼ˆæ’é™¤å›ºå®šå­—æ®µå’Œdateå­—æ®µï¼‰
        const fixedFields = ["stockCode", "stockName", "rating", "date"];
        const dataFields = allFields
          .map((field) => field.key)
          .filter((key) => key && !fixedFields.includes(key));

        // åˆ›å»ºè¡¨å¤´
        let headerHtml = `
                <div class="overflow-x-auto">
                  <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-700">
                      <tr>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-white uppercase tracking-wider">è‚¡ç¥¨åç§°</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-white uppercase tracking-wider">è‚¡ç¥¨ä»£ç </th>
        `;

        // åŠ¨æ€æ·»åŠ æŒ‡æ ‡åˆ—çš„è¡¨å¤´
        dataFields.forEach((fieldKey) => {
          const label = fieldMap[fieldKey] || fieldKey;
          // ç‰¹æ®Šå¤„ç†å¸‚å€¼å­—æ®µ
          const displayLabel = fieldKey === "mc" ? `${label}ï¼ˆä¸‡å…ƒï¼‰` : label;
          headerHtml += `<th class="px-6 py-4 text-left text-xs font-semibold text-white uppercase tracking-wider">${displayLabel}</th>`;
        });

        // æ·»åŠ è¯„åˆ†åˆ—
        headerHtml += `<th class="px-6 py-4 text-left text-xs font-semibold text-white uppercase tracking-wider">è¯„åˆ†</th>`;
        headerHtml += `</tr></thead><tbody class="bg-white divide-y divide-gray-200">`;

        // æ·»åŠ æ•°æ®è¡Œ
        stocks.forEach((stock) => {
          const ratingBgClass =
            stock.rating > 15
              ? "bg-green-100 text-green-800"
              : stock.rating > 0
              ? "bg-yellow-100 text-yellow-800"
              : "bg-red-100 text-red-800";

          // æ„å»ºå¯Œé€”é“¾æ¥
          const futuUrl = stock.stockCode
            ? `https://www.futunn.com/stock/${stock.stockCode}-HK`
            : null;

          let rowHtml = `
                      <tr class="group hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">
                          <span>${stock.stockName || ""}</span>
                          ${
                            futuUrl
                              ? `<a href="${futuUrl}" target="_blank" rel="noopener noreferrer" class="inline-flex items-center text-gray-400 hover:text-gray-600 opacity-0 group-hover:opacity-100 transition-opacity" title="åœ¨å¯Œé€”æŸ¥çœ‹">
                                  ğŸ”—
                                </a>`
                              : ""
                          }
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-800">${
                          stock.stockCode || "-"
                        }</td>
          `;

          // åŠ¨æ€æ·»åŠ æŒ‡æ ‡åˆ—çš„æ•°æ®
          dataFields.forEach((fieldKey) => {
            const value = stock[fieldKey];
            let displayValue = "-";

            // å¦‚æœå­—æ®µå­˜åœ¨ä¸”å€¼æœ‰æ•ˆï¼Œåˆ™æ ¼å¼åŒ–æ˜¾ç¤º
            if (value !== null && value !== undefined && value !== "") {
              const numValue = parseFloat(value);
              if (!isNaN(numValue)) {
                // è·å–å­—æ®µçš„label
                const label = fieldMap[fieldKey] || fieldKey;

                // æ£€æŸ¥labelæ˜¯å¦åŒ…å«"ä¸‡å…ƒ"æˆ–"ä¸‡"ï¼Œå¦‚æœåŒ…å«åˆ™è½¬æ¢ä¸ºä¸‡å…ƒ
                if (label.includes("ä¸‡å…ƒ") || label.includes("ä¸‡")) {
                  displayValue = (numValue / 10000).toFixed(2);
                } else {
                  // åˆ¤æ–­æ˜¯å¦ä¸ºç™¾åˆ†æ¯”å­—æ®µï¼ˆæ ¹æ®å­—æ®µåæˆ–é…ç½®ï¼‰
                  const isPercentage = label.includes("%");
                  if (isPercentage) {
                    displayValue = (numValue * 100).toFixed(2);
                    // ç™¾åˆ†æ¯”å­—æ®µå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ  % ç¬¦å·ï¼Œä½†é€šå¸¸å‰ç«¯æ˜¾ç¤ºæ—¶ä¸éœ€è¦ï¼Œå› ä¸ºè¡¨å¤´å·²ç»è¯´æ˜äº†
                  } else {
                    displayValue = numValue.toFixed(2);
                  }
                }
              }
            }
            // å¦‚æœå­—æ®µä¸å­˜åœ¨æˆ–å€¼ä¸ºnull/undefined/ç©ºå­—ç¬¦ä¸²ï¼ŒdisplayValueä¿æŒä¸º"-"

            rowHtml += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${displayValue}</td>`;
          });

          // æ·»åŠ è¯„åˆ†åˆ—
          rowHtml += `
                        <td class="px-6 py-4 whitespace-nowrap">
                          <span class="px-3 py-1 inline-flex text-xs font-bold rounded-full ${ratingBgClass}">
                            ${stock.rating || 0}
                          </span>
                        </td>
                      </tr>
          `;

          headerHtml += rowHtml;
        });

        headerHtml += `
                    </tbody>
                  </table>
                </div>
            `;

        container.innerHTML = headerHtml;
      }

      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      function showLoading() {
        const container = document.getElementById("resultTable");
        container.innerHTML =
          '<button type="button" class="inline-flex cursor-not-allowed items-center rounded-md bg-gray-700 px-4 py-2 text-sm leading-6 font-semibold text-white transition duration-150 ease-in-out" disabled=""><svg class="mr-3 -ml-1 size-5 animate-spin text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>æ­£åœ¨è·å–æ•°æ®...</button>';
      }

      // æ˜¾ç¤ºæ— ç»“æœçŠ¶æ€
      function showNoResults() {
        const container = document.getElementById("resultTable");
        container.innerHTML =
          '<div class="text-center py-16 text-gray-500 bg-gray-50 rounded-lg"><div>æš‚æ— ç»“æœ</div></div>';
        document.getElementById("resultCount").textContent = "";
      }
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>股票筛选工具</title>
    <!-- Tailwind CSS 本地文件 -->
    <script src="/static/tailwindcss.min.js"></script>
    <style>
      /* 保留必要的自定义样式 */
      .spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(59, 130, 246, 0.3);
        border-radius: 50%;
        border-top-color: #3b82f6;
        animation: spin 1s ease-in-out infinite;
        margin-right: 8px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- 筛选区域 -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <!-- 基础筛选 -->
        <div class="flex flex-wrap gap-4 mb-6">
          <div class="flex-1 min-w-[200px]">
            <label
              for="stockCode"
              class="block text-sm font-semibold text-gray-700 mb-2"
            >
              股票代码（可选）
            </label>
            <input
              type="text"
              id="stockCode"
              class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-colors"
              placeholder="如: 00700（留空则筛选所有股票）"
            />
          </div>

          <div class="flex-1 min-w-[200px]">
            <label
              for="date"
              class="block text-sm font-semibold text-gray-700 mb-2"
            >
              指定日期
            </label>
            <input
              type="date"
              id="date"
              class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-colors"
              required
            />
          </div>
        </div>

        <!-- 筛选条件标题 -->
        <div class="mb-4">
          <h3 class="text-sm font-semibold text-gray-600">
            筛选条件（仅在未输入股票代码时生效）
          </h3>
        </div>

        <!-- 指标筛选 -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          <!-- 市盈率 TTM -->
          <div class="flex flex-col">
            <label class="text-sm font-semibold text-gray-700 mb-2"
              >市盈率 TTM</label
            >
            <div class="flex items-center gap-2">
              <input
                type="number"
                id="peTtmMin"
                min="0"
                step="0.1"
                class="flex-1 px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-colors"
                placeholder="最小值"
              />

              <input
                type="number"
                id="peTtmMax"
                min="0"
                step="0.1"
                class="flex-1 px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-colors"
                placeholder="最大值"
              />
            </div>
          </div>

          <!-- 股息率 -->
          <div class="flex flex-col">
            <label class="text-sm font-semibold text-gray-700 mb-2"
              >股息率 (%)</label
            >
            <div class="flex items-center gap-2">
              <input
                type="number"
                id="dyrMin"
                min="0"
                step="0.1"
                class="flex-1 px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-colors"
                placeholder="最小值"
              />

              <input
                type="number"
                id="dyrMax"
                min="0"
                step="0.1"
                class="flex-1 px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-colors"
                placeholder="最大值"
              />
            </div>
          </div>

          <!-- 市净率 PB -->
          <div class="flex flex-col">
            <label class="text-sm font-semibold text-gray-700 mb-2"
              >市净率 PB</label
            >
            <div class="flex items-center gap-2">
              <input
                type="number"
                id="pbMin"
                min="0"
                step="0.1"
                class="flex-1 px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-colors"
                placeholder="最小值"
              />

              <input
                type="number"
                id="pbMax"
                min="0"
                step="0.1"
                class="flex-1 px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-colors"
                placeholder="最大值"
              />
            </div>
          </div>

          <!-- 市值 -->
          <div class="flex flex-col">
            <label class="text-sm font-semibold text-gray-700 mb-2"
              >市值（万元）</label
            >
            <div class="flex items-center gap-2">
              <input
                type="number"
                id="mcMin"
                min="0"
                step="1000"
                class="flex-1 px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-colors"
                placeholder="最小值"
              />

              <input
                type="number"
                id="mcMax"
                min="0"
                step="1000"
                class="flex-1 px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-colors"
                placeholder="最大值"
              />
            </div>
          </div>
        </div>

        <!-- 按钮组 -->
        <div class="flex gap-3">
          <button
            id="filterBtn"
            class="px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white font-semibold rounded-lg hover:from-green-600 hover:to-green-700 transform hover:-translate-y-0.5 transition-all duration-200 shadow-md hover:shadow-lg uppercase tracking-wide"
          >
            筛选
          </button>
          <button
            id="resetBtn"
            class="px-6 py-3 bg-gradient-to-r from-red-500 to-red-600 text-white font-semibold rounded-lg hover:from-red-600 hover:to-red-700 transform hover:-translate-y-0.5 transition-all duration-200 shadow-md hover:shadow-lg uppercase tracking-wide"
          >
            重置
          </button>
        </div>
      </div>

      <!-- 结果区域 -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-bold text-gray-800">筛选结果</h2>
          <span
            class="text-sm font-semibold text-gray-600"
            id="resultCount"
          ></span>
        </div>
        <div id="resultTable"></div>
      </div>
    </div>

    <script>
      // 基础调试，确保JavaScript正常执行
      try {
        console.log("JavaScript开始执行");
      } catch (e) {
        document.write("<h1>JavaScript执行出错:</h1><p>" + e.message + "</p>");
      }

      // 后端API配置
      const BACKEND_URL = "http://localhost:8001";

      // 页面加载完成后初始化
      try {
        document.addEventListener("DOMContentLoaded", () => {
          console.log("DOM加载完成，开始初始化页面");

          // 设置默认日期为今天
          const today = new Date().toISOString().split("T")[0];
          document.getElementById("date").value = today;
          console.log("设置默认日期为:", today);

          // 绑定按钮事件
          const filterBtn = document.getElementById("filterBtn");
          const resetBtn = document.getElementById("resetBtn");

          if (filterBtn && resetBtn) {
            filterBtn.addEventListener("click", handleFilter);
            resetBtn.addEventListener("click", handleReset);
            console.log("按钮事件绑定完成");
          } else {
            console.error("找不到按钮元素");
          }
        });
      } catch (e) {
        console.error("页面初始化失败:", e);
      }

      // 添加请求节流控制
      let isRequesting = false;
      const MIN_REQUEST_INTERVAL = 5000; // 最小请求间隔5秒

      // 筛选按钮点击事件
      async function handleFilter() {
        console.log("筛选按钮被点击");

        // 检查是否正在请求中
        if (isRequesting) {
          alert("请求正在处理中，请稍候再试");
          return;
        }

        try {
          // 设置请求状态为正在请求
          isRequesting = true;

          const stockCode = document.getElementById("stockCode").value.trim();
          const date = document.getElementById("date").value;

          // 验证日期是否填写
          if (!date) {
            alert("请选择指定日期");
            isRequesting = false;
            return;
          }

          // 显示加载状态
          showLoading();

          let stockData = [];

          // 判断使用哪个接口
          if (stockCode) {
            // 接口一：获取指定股票的基本面数据
            console.log("使用接口一：获取指定股票数据");
            stockData = await fetchStockFundamentals([stockCode], date);
          } else {
            // 接口二：根据筛选条件筛选股票
            console.log("使用接口二：筛选股票");
            stockData = await filterStocksByMetrics(date);
          }

          console.log("获取到的股票数据:", stockData);

          // 计算评分
          const stocksWithRating = calculateRating(stockData);

          // 显示结果
          displayResults(stocksWithRating);
        } catch (error) {
          console.error("操作失败:", error);

          // 针对不同错误类型显示友好的错误消息
          if (error.message.includes("429")) {
            alert(
              "请求次数过多，请稍后再试。\n\n建议：\n1. 减少同时查询的股票数量\n2. 延长两次查询之间的时间间隔"
            );
          } else {
            alert(`操作失败: ${error.message}`);
          }

          showNoResults();
        } finally {
          // 延迟重置请求状态，确保最小请求间隔
          setTimeout(() => {
            isRequesting = false;
            console.log("请求状态重置，可以发起新请求");
          }, MIN_REQUEST_INTERVAL);
        }
      }

      // 重置按钮点击事件
      function handleReset() {
        document.getElementById("stockCode").value = "";
        document.getElementById("peTtmMin").value = "";
        document.getElementById("peTtmMax").value = "";
        document.getElementById("dyrMin").value = "";
        document.getElementById("dyrMax").value = "";
        document.getElementById("pbMin").value = "";
        document.getElementById("pbMax").value = "";
        document.getElementById("mcMin").value = "";
        document.getElementById("mcMax").value = "";
        document.getElementById("date").value = new Date()
          .toISOString()
          .split("T")[0];

        // 清空结果
        showNoResults();
      }

      // 接口一：获取指定股票的基本面数据
      async function fetchStockFundamentals(stockCodes, date) {
        try {
          console.log("调用接口一：获取指定股票基本面数据");

          const requestData = {
            stockCodes: stockCodes,
            metricsList: ["pe_ttm", "pb", "mc", "dyr"],
            date: date,
          };

          const response = await fetch(BACKEND_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(requestData),
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(
              errorData.error || `HTTP错误!状态码: ${response.status}`
            );
          }

          const result = await response.json();
          console.log("接口一返回的数据:", result);

          // 返回股票数据
          return result.data || [];
        } catch (error) {
          console.error("获取股票基本面数据失败:", error);
          throw error;
        }
      }

      // 接口二：根据筛选条件筛选股票
      async function filterStocksByMetrics(date) {
        try {
          console.log("调用接口二：根据筛选条件筛选股票");

          // 构建 metricsFilter 对象
          const metricsFilter = {};

          // 市盈率 TTM 筛选
          const peTtmMin = parseFloat(
            document.getElementById("peTtmMin").value
          );
          const peTtmMax = parseFloat(
            document.getElementById("peTtmMax").value
          );
          if (!isNaN(peTtmMin) || !isNaN(peTtmMax)) {
            metricsFilter.pe_ttm = [
              !isNaN(peTtmMin) ? peTtmMin : null,
              !isNaN(peTtmMax) ? peTtmMax : null,
            ];
          }

          // 股息率筛选
          const dyrMin = parseFloat(document.getElementById("dyrMin").value);
          const dyrMax = parseFloat(document.getElementById("dyrMax").value);
          if (!isNaN(dyrMin) || !isNaN(dyrMax)) {
            metricsFilter.dyr = [
              !isNaN(dyrMin) ? dyrMin : null,
              !isNaN(dyrMax) ? dyrMax : null,
            ];
          }

          // 市净率 PB 筛选
          const pbMin = parseFloat(document.getElementById("pbMin").value);
          const pbMax = parseFloat(document.getElementById("pbMax").value);
          if (!isNaN(pbMin) || !isNaN(pbMax)) {
            metricsFilter.pb = [
              !isNaN(pbMin) ? pbMin : null,
              !isNaN(pbMax) ? pbMax : null,
            ];
          }

          // 市值 MC 筛选（注意：API返回的市值单位需要确认，这里假设是元）
          const mcMin = parseFloat(document.getElementById("mcMin").value);
          const mcMax = parseFloat(document.getElementById("mcMax").value);
          if (!isNaN(mcMin) || !isNaN(mcMax)) {
            // 市值单位转换：前端输入万元，转换为元（API返回的可能是元）
            // 如果API返回的是万元，则不需要乘以10000
            metricsFilter.mc = [
              !isNaN(mcMin) ? mcMin * 10000 : null, // 万元转元
              !isNaN(mcMax) ? mcMax * 10000 : null,
            ];
          }

          // 检查是否有筛选条件
          if (Object.keys(metricsFilter).length === 0) {
            alert("请至少输入一个筛选条件");
            throw new Error("缺少筛选条件");
          }

          const requestData = {
            metricsFilter: metricsFilter,
            date: date,
          };

          console.log("发送筛选请求:", requestData);

          const response = await fetch(BACKEND_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(requestData),
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(
              errorData.error || `HTTP错误!状态码: ${response.status}`
            );
          }

          const result = await response.json();
          console.log("接口二返回的数据:", result);

          // 返回筛选后的股票数据
          return result.data || [];
        } catch (error) {
          console.error("筛选股票失败:", error);
          throw error;
        }
      }

      // 计算评分
      function calculateRating(stocks) {
        return stocks.map((stock) => {
          let rating = 0;

          // 获取数据
          const peTtm = parseFloat(stock.pe_ttm) || 0;
          const pb = parseFloat(stock.pb) || 0;
          const mc = parseFloat(stock.mc) || 0;
          const dyr = parseFloat(stock.dyr) || 0;

          // 市盈率TTM评分（0-15为优秀）
          if (peTtm > 0 && peTtm <= 15) {
            rating += 10;
          } else if (peTtm > 15 && peTtm <= 25) {
            rating += 5;
          } else if (peTtm > 0) {
            rating -= 5;
          }

          // 市净率PB评分（0-2为优秀）
          if (pb > 0 && pb <= 2) {
            rating += 10;
          } else if (pb > 2 && pb <= 3) {
            rating += 5;
          } else if (pb > 0) {
            rating -= 5;
          }

          // 股息率评分（>3%为优秀）
          if (dyr >= 3) {
            rating += 10;
          } else if (dyr > 0) {
            rating += 5;
          }

          // 获取股票名称
          const stockName = stock.stockCode;

          return {
            ...stock,
            stockName: stockName,
            rating: rating,
          };
        });
      }

      // 显示结果
      function displayResults(stocks) {
        const container = document.getElementById("resultTable");
        const countElement = document.getElementById("resultCount");

        countElement.textContent = `共 ${stocks.length} 条结果`;

        if (stocks.length === 0) {
          showNoResults();
          return;
        }

        // 创建表格
        let html = `
                <div class="overflow-x-auto">
                  <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gradient-to-r from-blue-600 to-blue-700">
                      <tr>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-white uppercase tracking-wider">股票名称</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-white uppercase tracking-wider">股票代码</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-white uppercase tracking-wider">市盈率 TTM</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-white uppercase tracking-wider">市净率 PB</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-white uppercase tracking-wider">市值（万元）</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-white uppercase tracking-wider">股息率 (%)</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-white uppercase tracking-wider">评分</th>
                      </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
            `;

        // 添加数据行
        stocks.forEach((stock) => {
          const ratingBgClass =
            stock.rating > 15
              ? "bg-green-100 text-green-800"
              : stock.rating > 0
              ? "bg-yellow-100 text-yellow-800"
              : "bg-red-100 text-red-800";

          // 格式化市值（如果存在，假设API返回的是元，转换为万元显示）
          const mc = stock.mc ? (parseFloat(stock.mc) / 10000).toFixed(2) : "-";

          html += `
                      <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">${
                          stock.stockName
                        }</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-blue-600">${
                          stock.stockCode
                        }</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${
                          stock.pe_ttm
                            ? parseFloat(stock.pe_ttm).toFixed(2)
                            : "-"
                        }</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${
                          stock.pb ? parseFloat(stock.pb).toFixed(2) : "-"
                        }</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${mc}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${
                          stock.dyr ? parseFloat(stock.dyr).toFixed(2) : "-"
                        }</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                          <span class="px-3 py-1 inline-flex text-xs font-bold rounded-full ${ratingBgClass}">
                            ${stock.rating}
                          </span>
                        </td>
                      </tr>
                  `;
        });

        html += `
                    </tbody>
                  </table>
                </div>
            `;

        container.innerHTML = html;
      }

      // 显示加载状态
      function showLoading() {
        const container = document.getElementById("resultTable");
        container.innerHTML =
          '<div class="text-center py-12 text-blue-600 text-lg"><span class="spinner"></span>正在获取数据...</div>';
      }

      // 显示无结果状态
      function showNoResults() {
        const container = document.getElementById("resultTable");
        container.innerHTML =
          '<div class="text-center py-16 text-gray-500 text-lg bg-gray-50 rounded-lg">暂无结果</div>';
        document.getElementById("resultCount").textContent = "";
      }
    </script>
  </body>
</html>

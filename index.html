<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>è‚¡ç¥¨ç­›é€‰å·¥å…·</title>
    <!-- Tailwind CSS æœ¬åœ°æ–‡ä»¶ -->
    <script src="/static/tailwindcss.min.js"></script>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- ç­›é€‰åŒºåŸŸ -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-4">
        <!-- åŸºç¡€ç­›é€‰ -->
        <div class="flex flex-wrap gap-4 mb-6">
          <div class="flex-1 min-w-[200px]">
            <label
              for="stockCode"
              class="block font-semibold text-gray-700 mb-2"
            >
              è‚¡ç¥¨ä»£ç 
            </label>
            <div
              class="flex items-center gap-2 border-2 border-gray-200 rounded-lg px-4 py-2 focus:outline-none focus:border-blue-300 focus:ring-2 focus:ring-blue-200 transition-colors"
            >
              <input
                type="text"
                id="stockCode"
                class="flex-1 text-sm outline-none"
                placeholder="å¦‚: 00700ï¼ˆç•™ç©ºåˆ™ç­›é€‰æ‰€æœ‰è‚¡ç¥¨ï¼‰"
              />
              <svg
                id="searchStockCodeBtn"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 16 16"
                class="-ml-0.5 size-4 fill-gray-600 dark:fill-gray-500 cursor-pointer"
              >
                <path
                  fill-rule="evenodd"
                  d="M9.965 11.026a5 5 0 1 1 1.06-1.06l2.755 2.754a.75.75 0 1 1-1.06 1.06l-2.755-2.754ZM10.5 7a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0Z"
                  clip-rule="evenodd"
                ></path>
              </svg>
            </div>
          </div>

          <div class="flex-1 min-w-[200px]">
            <label for="date" class="block font-semibold text-gray-700 mb-2">
              æŒ‡å®šæ—¥æœŸ
            </label>
            <input
              type="date"
              id="date"
              class="w-full text-sm px-4 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-300 focus:ring-2 focus:ring-blue-200 transition-colors"
              required
            />
          </div>
        </div>
      </div>

      <div
        id="fundamentalFilter"
        class="bg-white rounded-lg shadow-md p-6 mb-6"
      >
        <!-- ç­›é€‰æ¡ä»¶æ ‡é¢˜ -->
        <div class="mb-4">
          <h3 class="font-semibold text-gray-600 flex items-center">
            åŸºæœ¬é¢ç­›é€‰ï¼ˆä»…åœ¨æœªè¾“å…¥è‚¡ç¥¨ä»£ç æ—¶å¯ç”¨ï¼‰
            <div
              id="fundamentalFilterSettingBtn"
              class="rounded-md border border-gray-300 text-gray-500 cursor-pointer"
            >
              <svg width="18" height="18" viewBox="0 0 20 20">
                <path
                  d="M13 13h4-4V8H7v5h6v4-4H7V8H3h4V3v5h6V3v5h4-4v5zm-6 0v4-4H3h4z"
                  stroke="currentColor"
                  fill="none"
                  fill-rule="evenodd"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                ></path>
              </svg>
            </div>
          </h3>
        </div>

        <!-- æŒ‡æ ‡ç­›é€‰ï¼ˆåŠ¨æ€ç”Ÿæˆï¼‰ -->
        <div id="filterFieldsContainer" class="flex flex-wrap gap-6 mb-6"></div>

        <div class="border-t mt-5 mb-5 border-gray-200"></div>

        <div
          id="filterConditionsDescription"
          class="text-sm text-gray-500 mb-4"
        ></div>
        <!-- æŒ‰é’®ç»„ -->
        <div class="flex gap-6">
          <button
            id="filterBtn"
            class="flex-1 px-3 py-3 text-sm text-white font-medium rounded-lg bg-gray-700 leading-5 enabled:hover:bg-gray-800 transform transition-all duration-200 tracking-widest"
          >
            ç­›é€‰
          </button>
          <button
            id="resetBtn"
            class="flex-1 px-3 py-3 text-sm font-medium rounded-lg transform transition-all duration-200 tracking-widest border-2 border-gray-200 text-gray-500 enabled:hover:text-gray-700 enabled:hover:border-gray-300"
          >
            é‡ç½®
          </button>
        </div>
      </div>

      <!-- ç»“æœåŒºåŸŸ -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex justify-between items-center mb-6">
          <h3 class="font-semibold text-gray-600">ç­›é€‰ç»“æœ</h3>
          <span
            class="text-sm font-medium text-gray-600"
            id="resultCount"
          ></span>
        </div>
        <div id="resultTable"></div>
      </div>
    </div>

    <!-- ç­›é€‰é¡¹é…ç½®å¼¹çª— -->
    <div
      id="filterConfigModal"
      class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center"
      style="display: none"
    >
      <div
        class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-hidden flex flex-col"
      >
        <!-- å¼¹çª—æ ‡é¢˜ -->
        <div class="px-6 py-4 border-b border-gray-200">
          <h2 class="text-xl font-semibold text-gray-800">åŸºæœ¬é¢ç­›é€‰é¡¹é…ç½®</h2>
        </div>

        <!-- å¼¹çª—å†…å®¹ -->
        <div class="px-6 py-4 flex-1 overflow-y-auto">
          <!-- æ·»åŠ æŒ‰é’® -->
          <button
            id="addFilterFieldBtn"
            class="mb-4 w-full h-16 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center text-gray-500 hover:border-gray-400 hover:text-gray-600 transition-colors"
          >
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            <span class="ml-2">æ·»åŠ æ–°ç­›é€‰é¡¹</span>
          </button>

          <!-- åˆ†éš”çº¿ -->
          <div class="border-t border-gray-200 mb-4"></div>

          <!-- ç­›é€‰é¡¹åˆ—è¡¨ -->
          <div id="filterFieldsList" class="space-y-2">
            <!-- è¡¨å¤´ -->
            <div
              class="grid grid-cols-3 gap-4 mb-2 pb-2 border-b border-gray-200"
            >
              <div class="font-semibold text-sm text-gray-700">ç­›é€‰é¡¹åç§°</div>
              <div class="font-semibold text-sm text-gray-700">ç†æä»æŒ‡æ ‡</div>
              <div class="font-semibold text-sm text-gray-700">æ“ä½œ</div>
            </div>
            <!-- ç­›é€‰é¡¹åˆ—è¡¨é¡¹å°†åŠ¨æ€æ’å…¥è¿™é‡Œ -->
          </div>
        </div>

        <!-- å¼¹çª—åº•éƒ¨æŒ‰é’® -->
        <div class="px-6 py-4 border-t border-gray-200 flex justify-end gap-3">
          <button
            id="saveConfigBtn"
            class="px-4 py-2 text-sm font-medium text-white bg-gray-700 rounded-lg hover:bg-gray-800 transition-colors"
          >
            ä¿å­˜
          </button>
          <button
            id="cancelConfigBtn"
            class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
          >
            å–æ¶ˆ
          </button>
        </div>
      </div>
    </div>

    <!-- ç­›é€‰é¡¹é…ç½®å¼¹çª—è„šæœ¬ -->
    <script src="/static/filter-config-modal.js"></script>

    <script>
      // åŸºç¡€è°ƒè¯•ï¼Œç¡®ä¿JavaScriptæ­£å¸¸æ‰§è¡Œ
      try {
        console.log("JavaScriptå¼€å§‹æ‰§è¡Œ");
      } catch (e) {
        document.write("<h1>JavaScriptæ‰§è¡Œå‡ºé”™:</h1><p>" + e.message + "</p>");
      }

      // åç«¯APIé…ç½®
      const BACKEND_URL = "http://localhost:8001";
      const FILTER_CONFIG_API = `${BACKEND_URL}/api/filter-config`;

      // å°† BACKEND_URL æš´éœ²åˆ°å…¨å±€ï¼Œä¾› filter-config-modal.js ä½¿ç”¨
      window.BACKEND_URL = BACKEND_URL;

      // ç­›é€‰æ§ä»¶é€šç”¨é…ç½®
      const FILTER_INPUT_CONFIG = {
        step: 0.1,
        placeholderMin: "æœ€ä½",
        placeholderMax: "æœ€é«˜",
      };

      // ç­›é€‰é¡¹é…ç½®ï¼ˆç”¨äºåŠ¨æ€ç”Ÿæˆç­›é€‰æ§ä»¶ï¼‰
      // ä»åç«¯åŠ è½½çš„é…ç½®ï¼ˆåˆå§‹åŒ–ä¸ºç©ºæ•°ç»„ï¼‰
      // æš´éœ²åˆ°å…¨å±€ï¼Œä¾›å¼¹çª—æ¨¡å—ä½¿ç”¨
      let FILTER_FIELDS = [];
      window.FILTER_FIELDS = FILTER_FIELDS;

      // ä»åç«¯åŠ è½½ç­›é€‰é¡¹é…ç½®
      async function loadFilterConfig() {
        try {
          console.log("æ­£åœ¨ä»åç«¯åŠ è½½ç­›é€‰é¡¹é…ç½®...");
          const response = await fetch(FILTER_CONFIG_API);

          if (!response.ok) {
            throw new Error(`HTTPé”™è¯¯!çŠ¶æ€ç : ${response.status}`);
          }

          const result = await response.json();
          const configData = result.data || [];

          // ç¡®ä¿æ¯ä¸ªå­—æ®µéƒ½æœ‰ minId å’Œ maxId
          configData.forEach((field) => {
            if (!field.minId && field.key) {
              field.minId = `${field.key.trim()}Min`;
            }
            if (!field.maxId && field.key) {
              field.maxId = `${field.key.trim()}Max`;
            }
          });

          FILTER_FIELDS = configData;
          window.FILTER_FIELDS = FILTER_FIELDS; // åŒæ­¥åˆ°å…¨å±€
          console.log(`æˆåŠŸåŠ è½½ç­›é€‰é¡¹é…ç½®ï¼Œå…± ${FILTER_FIELDS.length} é¡¹`);
        } catch (error) {
          console.error("åŠ è½½ç­›é€‰é¡¹é…ç½®å¤±è´¥:", error);
          FILTER_FIELDS = [];
          window.FILTER_FIELDS = FILTER_FIELDS; // åŒæ­¥åˆ°å…¨å±€
        }
      }

      // æ¸²æŸ“å•ä¸ªåŒºé—´ç­›é€‰æ§ä»¶
      function renderRangeFilterField(field) {
        return `
          <div class="flex flex-col">
            <label for="${field.minId}" class="block font-medium text-sm text-gray-700 mb-2">
              ${field.label}
            </label>
            <div class="flex items-center text-gray-500">
              <input
                type="number"
                id="${field.minId}"
                step="${FILTER_INPUT_CONFIG.step}"
                class="md:w-[100px] w-1/2 text-sm px-4 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-300 focus:ring-2 focus:ring-blue-200 transition-colors"
                placeholder="${FILTER_INPUT_CONFIG.placeholderMin}"
              />
              <div class="mx-1">~</div>
              <input
                type="number"
                id="${field.maxId}"
                step="${FILTER_INPUT_CONFIG.step}"
                class="md:w-[100px] w-1/2 text-sm px-4 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-300 focus:ring-2 focus:ring-blue-200 transition-colors"
                placeholder="${FILTER_INPUT_CONFIG.placeholderMax}"
              />
            </div>
          </div>
        `;
      }

      // åˆå§‹åŒ–ç­›é€‰æ§ä»¶
      function initFilterFields() {
        const container = document.getElementById("filterFieldsContainer");
        if (!container) return;

        // ä»å…¨å±€å˜é‡è¯»å–é…ç½®ï¼ˆç¡®ä¿ä½¿ç”¨æœ€æ–°å€¼ï¼‰
        const fields = window.FILTER_FIELDS || FILTER_FIELDS || [];
        container.innerHTML = fields.map(renderRangeFilterField).join("");

        // ä¸ºæ‰€æœ‰ç­›é€‰è¾“å…¥æ¡†ç»‘å®š input äº‹ä»¶ï¼Œå®æ—¶æ›´æ–°ç­›é€‰æ¡ä»¶æè¿°
        fields.forEach((field) => {
          const minInput = document.getElementById(field.minId);
          const maxInput = document.getElementById(field.maxId);
          if (minInput) {
            minInput.addEventListener(
              "input",
              updateFilterConditionsDescription
            );
          }
          if (maxInput) {
            maxInput.addEventListener(
              "input",
              updateFilterConditionsDescription
            );
          }
        });

        // åˆå§‹åŒ–æ—¶æ›´æ–°ä¸€æ¬¡ç­›é€‰æ¡ä»¶æè¿°
        updateFilterConditionsDescription();
      }

      // æ ¹æ®è‚¡ç¥¨ä»£ç è¾“å…¥æ¡†å†…å®¹ï¼Œç¦ç”¨/å¯ç”¨åŸºæœ¬é¢ç­›é€‰æ§ä»¶
      function updateFilterControlsState() {
        const stockCodeInput = document.getElementById("stockCode");
        const container = document.getElementById("filterFieldsContainer");
        const filterBtn = document.getElementById("filterBtn");
        const resetBtn = document.getElementById("resetBtn");
        if (!stockCodeInput || !container) return;

        const hasStockCode = stockCodeInput.value.trim().length > 0;
        const inputs = container.querySelectorAll('input[type="number"]');

        inputs.forEach((input) => {
          input.disabled = hasStockCode;
          if (hasStockCode) {
            input.classList.add(
              "bg-gray-100",
              "cursor-not-allowed",
              "opacity-60"
            );
          } else {
            input.classList.remove(
              "bg-gray-100",
              "cursor-not-allowed",
              "opacity-60"
            );
          }
        });

        // å½“è‚¡ç¥¨ä»£ç æœ‰å†…å®¹æ—¶ï¼Œç¦ç”¨ç­›é€‰å’Œé‡ç½®æŒ‰é’®
        if (filterBtn) {
          filterBtn.disabled = hasStockCode;
          if (hasStockCode) {
            filterBtn.classList.add("cursor-not-allowed", "opacity-60");
          } else {
            filterBtn.classList.remove("cursor-not-allowed", "opacity-60");
          }
        }
        if (resetBtn) {
          resetBtn.disabled = hasStockCode;
          if (hasStockCode) {
            resetBtn.classList.add("cursor-not-allowed", "opacity-60");
          } else {
            resetBtn.classList.remove("cursor-not-allowed", "opacity-60");
          }
        }
      }

      // ç›‘å¬ç­›é€‰é¡¹é…ç½®æ›´æ–°äº‹ä»¶ï¼ˆåœ¨ DOMContentLoaded ä¹‹å‰æ³¨å†Œï¼Œç¡®ä¿èƒ½æ•è·äº‹ä»¶ï¼‰
      function handleFilterConfigUpdated(event) {
        console.log("ç­›é€‰é¡¹é…ç½®å·²æ›´æ–°ï¼Œé‡æ–°åˆå§‹åŒ–ç­›é€‰æ§ä»¶", event);
        // æ›´æ–°å…¨å±€ FILTER_FIELDS å˜é‡
        if (event.detail && event.detail.config) {
          FILTER_FIELDS = event.detail.config;
          window.FILTER_FIELDS = FILTER_FIELDS; // åŒæ­¥åˆ°å…¨å±€
          console.log("å·²æ›´æ–° FILTER_FIELDS:", FILTER_FIELDS);
        }
        // é‡æ–°åˆå§‹åŒ–ç­›é€‰æ§ä»¶
        initFilterFields();
        // æ›´æ–°ç­›é€‰æ¡ä»¶æè¿°
        updateFilterConditionsDescription();
      }

      // ç«‹å³æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨ï¼ˆä¸ç­‰å¾… DOMContentLoadedï¼‰
      document.addEventListener(
        "filterConfigUpdated",
        handleFilterConfigUpdated
      );
      // åŒæ—¶ä¹Ÿç›‘å¬ window å¯¹è±¡ä¸Šçš„äº‹ä»¶ï¼ˆåŒé‡ä¿é™©ï¼‰
      window.addEventListener("filterConfigUpdated", handleFilterConfigUpdated);

      // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
      try {
        document.addEventListener("DOMContentLoaded", async () => {
          console.log("DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–é¡µé¢");

          // å…ˆåŠ è½½ç­›é€‰é¡¹é…ç½®
          await loadFilterConfig();

          // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
          const today = new Date().toISOString().split("T")[0];
          document.getElementById("date").value = today;
          console.log("è®¾ç½®é»˜è®¤æ—¥æœŸä¸º:", today);

          // ç»‘å®šæŒ‰é’®äº‹ä»¶
          const filterBtn = document.getElementById("filterBtn");
          const resetBtn = document.getElementById("resetBtn");
          const stockCodeInput = document.getElementById("stockCode");
          const searchStockCodeBtn =
            document.getElementById("searchStockCodeBtn");

          if (filterBtn && resetBtn) {
            filterBtn.addEventListener("click", handleFilter);
            resetBtn.addEventListener("click", handleReset);
            console.log("æŒ‰é’®äº‹ä»¶ç»‘å®šå®Œæˆ");
          } else {
            console.error("æ‰¾ä¸åˆ°æŒ‰é’®å…ƒç´ ");
          }

          // è‚¡ç¥¨ä»£ç è¾“å…¥æ—¶æ›´æ–°åŸºæœ¬é¢ç­›é€‰çŠ¶æ€
          if (stockCodeInput) {
            stockCodeInput.addEventListener("input", () => {
              updateFilterControlsState();
              updateFilterConditionsDescription();
            });
            // åœ¨è¾“å…¥æ¡†ä¸­æŒ‰å›è½¦æ—¶è§¦å‘ç­›é€‰
            stockCodeInput.addEventListener("keydown", (event) => {
              if (event.key === "Enter") {
                event.preventDefault();
                // å›è½¦åè®©è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹
                stockCodeInput.blur();
                handleFilter();
              }
            });
          }

          // ç‚¹å‡»æ”¾å¤§é•œå›¾æ ‡æ—¶ï¼Œè§¦å‘æŸ¥è¯¢
          if (searchStockCodeBtn) {
            searchStockCodeBtn.addEventListener("click", () => {
              handleFilter();
            });
          }

          // åŠ¨æ€æ¸²æŸ“ç­›é€‰æ§ä»¶
          initFilterFields();

          // åˆå§‹åŒ–ä¸€æ¬¡çŠ¶æ€
          updateFilterControlsState();
        });
      } catch (e) {
        console.error("é¡µé¢åˆå§‹åŒ–å¤±è´¥:", e);
      }

      // æ·»åŠ è¯·æ±‚èŠ‚æµæ§åˆ¶
      let isRequesting = false;

      // åˆ‡æ¢æ•´é¡µè¡¨å•çš„å¯ç”¨/ç¦ç”¨çŠ¶æ€
      function setUIBusy(isBusy) {
        const root = document;
        const inputs = root.querySelectorAll("input, select, textarea");
        const buttons = root.querySelectorAll("button");

        inputs.forEach((el) => {
          if (el.id === "stockCode") {
            // è‚¡ç¥¨ä»£ç è¾“å…¥æ¡†ä¹Ÿä¸€èµ·ç¦ç”¨
            el.disabled = isBusy;
          } else {
            el.disabled = isBusy;
          }
          if (isBusy) {
            el.classList.add("cursor-not-allowed", "opacity-60");
          } else {
            el.classList.remove("cursor-not-allowed", "opacity-60");
          }
        });

        buttons.forEach((btn) => {
          btn.disabled = isBusy;
          if (isBusy) {
            btn.classList.add("cursor-not-allowed", "opacity-60");
          } else {
            btn.classList.remove("cursor-not-allowed", "opacity-60");
          }
        });
      }

      // ç­›é€‰æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      async function handleFilter() {
        console.log("ç­›é€‰æŒ‰é’®è¢«ç‚¹å‡»");

        // æ£€æŸ¥æ˜¯å¦æ­£åœ¨è¯·æ±‚ä¸­
        if (isRequesting) {
          alert("è¯·æ±‚æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™å†è¯•");
          return;
        }

        // å…ˆè¿›è¡Œæ‰€æœ‰éªŒè¯æ£€æŸ¥ï¼Œå†è®¾ç½®è¯·æ±‚çŠ¶æ€
        const stockCode = document.getElementById("stockCode").value.trim();
        const date = document.getElementById("date").value;

        // éªŒè¯æ—¥æœŸæ˜¯å¦å¡«å†™
        if (!date) {
          alert("è¯·é€‰æ‹©æŒ‡å®šæ—¥æœŸ");
          return;
        }

        // å¦‚æœæ²¡æœ‰è‚¡ç¥¨ä»£ç ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰ç­›é€‰æ¡ä»¶
        if (!stockCode) {
          const hasFilter = checkHasFilterConditions();
          if (!hasFilter) {
            alert("è¯·è‡³å°‘è¾“å…¥ä¸€ä¸ªç­›é€‰æ¡ä»¶");
            return;
          }
        }

        // æ‰€æœ‰éªŒè¯é€šè¿‡åï¼Œè®¾ç½®è¯·æ±‚çŠ¶æ€
        try {
          isRequesting = true;
          setUIBusy(true);

          // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
          showLoading();

          let stockData = [];

          // åˆ¤æ–­ä½¿ç”¨å“ªä¸ªæ¥å£
          if (stockCode) {
            // æ¥å£ä¸€ï¼šè·å–æŒ‡å®šè‚¡ç¥¨çš„åŸºæœ¬é¢æ•°æ®
            console.log("ä½¿ç”¨æ¥å£ä¸€ï¼šè·å–æŒ‡å®šè‚¡ç¥¨æ•°æ®");
            stockData = await fetchStockFundamentals([stockCode], date);
          } else {
            // æ¥å£äºŒï¼šæ ¹æ®ç­›é€‰æ¡ä»¶ç­›é€‰è‚¡ç¥¨
            console.log("ä½¿ç”¨æ¥å£äºŒï¼šç­›é€‰è‚¡ç¥¨");
            stockData = await filterStocksByMetrics(date);
          }

          console.log("è·å–åˆ°çš„è‚¡ç¥¨æ•°æ®:", stockData);

          // è®¡ç®—è¯„åˆ†
          const stocksWithRating = calculateRating(stockData);

          // æ˜¾ç¤ºç»“æœ
          displayResults(stocksWithRating);
        } catch (error) {
          console.error("æ“ä½œå¤±è´¥:", error);

          // é’ˆå¯¹ä¸åŒé”™è¯¯ç±»å‹æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯æ¶ˆæ¯
          if (error.message.includes("ç¼ºå°‘ç­›é€‰æ¡ä»¶")) {
            // è¿™ä¸ªé”™è¯¯å·²ç»åœ¨è°ƒç”¨å‰æ£€æŸ¥è¿‡äº†ï¼Œä¸åº”è¯¥åˆ°è¾¾è¿™é‡Œï¼Œä½†ä½œä¸ºé˜²å¾¡æ€§å¤„ç†
            // ä¸æ˜¾ç¤º alertï¼Œå› ä¸ºå·²ç»åœ¨è°ƒç”¨å‰æ˜¾ç¤ºè¿‡äº†
          } else if (error.message.includes("429")) {
            alert(
              "è¯·æ±‚æ¬¡æ•°è¿‡å¤šï¼Œè¯·ç¨åå†è¯•ã€‚\n\nå»ºè®®ï¼š\n1. å‡å°‘åŒæ—¶æŸ¥è¯¢çš„è‚¡ç¥¨æ•°é‡\n2. å»¶é•¿ä¸¤æ¬¡æŸ¥è¯¢ä¹‹é—´çš„æ—¶é—´é—´éš”"
            );
          } else {
            alert(`æ“ä½œå¤±è´¥: ${error.message}`);
          }

          showNoResults();
        } finally {
          isRequesting = false;
          console.log("è¯·æ±‚çŠ¶æ€é‡ç½®ï¼Œå¯ä»¥å‘èµ·æ–°è¯·æ±‚");
          setUIBusy(false);
          // æ ¹æ®å½“å‰è‚¡ç¥¨ä»£ç è¾“å…¥å†…å®¹ï¼Œæ¢å¤ç­›é€‰åŒºåŸŸåº”æœ‰çš„ç¦ç”¨çŠ¶æ€
          updateFilterControlsState();
        }
      }

      // é‡ç½®æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      function handleReset() {
        document.getElementById("stockCode").value = "";
        document.getElementById("peTtmMin").value = "";
        document.getElementById("peTtmMax").value = "";
        document.getElementById("dyrMin").value = "";
        document.getElementById("dyrMax").value = "";
        document.getElementById("pbMin").value = "";
        document.getElementById("pbMax").value = "";
        document.getElementById("mcMin").value = "";
        document.getElementById("mcMax").value = "";
        document.getElementById("date").value = new Date()
          .toISOString()
          .split("T")[0];

        // æ›´æ–°ç­›é€‰æ§ä»¶çš„ç¦ç”¨çŠ¶æ€ï¼ˆå› ä¸ºè‚¡ç¥¨ä»£ç å·²æ¸…ç©ºï¼Œåº”è¯¥å¯ç”¨åŸºæœ¬é¢ç­›é€‰ï¼‰
        updateFilterControlsState();

        // æ›´æ–°ç­›é€‰æ¡ä»¶æè¿°
        updateFilterConditionsDescription();

        // æ³¨æ„ï¼šä¸æ¸…ç©ºç­›é€‰ç»“æœï¼Œä¿ç•™å½“å‰æ˜¾ç¤ºçš„æ•°æ®
      }

      // æ¥å£ä¸€ï¼šè·å–æŒ‡å®šè‚¡ç¥¨çš„åŸºæœ¬é¢æ•°æ®
      async function fetchStockFundamentals(stockCodes, date) {
        try {
          console.log("è°ƒç”¨æ¥å£ä¸€ï¼šè·å–æŒ‡å®šè‚¡ç¥¨åŸºæœ¬é¢æ•°æ®");

          const requestData = {
            stockCodes: stockCodes,
            metricsList: ["pe_ttm", "pb", "mc", "dyr"],
            date: date,
          };

          const response = await fetch(BACKEND_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(requestData),
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(
              errorData.error || `HTTPé”™è¯¯!çŠ¶æ€ç : ${response.status}`
            );
          }

          const result = await response.json();
          console.log("æ¥å£ä¸€è¿”å›çš„æ•°æ®:", result);

          // è¿”å›è‚¡ç¥¨æ•°æ®
          return result.data || [];
        } catch (error) {
          console.error("è·å–è‚¡ç¥¨åŸºæœ¬é¢æ•°æ®å¤±è´¥:", error);
          throw error;
        }
      }

      // æ£€æŸ¥æ˜¯å¦æœ‰ç­›é€‰æ¡ä»¶
      function checkHasFilterConditions() {
        const peTtmMin = parseFloat(document.getElementById("peTtmMin").value);
        const peTtmMax = parseFloat(document.getElementById("peTtmMax").value);
        const dyrMin = parseFloat(document.getElementById("dyrMin").value);
        const dyrMax = parseFloat(document.getElementById("dyrMax").value);
        const pbMin = parseFloat(document.getElementById("pbMin").value);
        const pbMax = parseFloat(document.getElementById("pbMax").value);
        const mcMin = parseFloat(document.getElementById("mcMin").value);
        const mcMax = parseFloat(document.getElementById("mcMax").value);

        return (
          !isNaN(peTtmMin) ||
          !isNaN(peTtmMax) ||
          !isNaN(dyrMin) ||
          !isNaN(dyrMax) ||
          !isNaN(pbMin) ||
          !isNaN(pbMax) ||
          !isNaN(mcMin) ||
          !isNaN(mcMax)
        );
      }

      // æ¥å£äºŒï¼šæ ¹æ®ç­›é€‰æ¡ä»¶ç­›é€‰è‚¡ç¥¨
      async function filterStocksByMetrics(date) {
        try {
          console.log("è°ƒç”¨æ¥å£äºŒï¼šæ ¹æ®ç­›é€‰æ¡ä»¶ç­›é€‰è‚¡ç¥¨");

          // æ„å»º metricsFilter å¯¹è±¡
          const metricsFilter = {};

          // å¸‚ç›ˆç‡ TTM ç­›é€‰
          const peTtmMin = parseFloat(
            document.getElementById("peTtmMin").value
          );
          const peTtmMax = parseFloat(
            document.getElementById("peTtmMax").value
          );
          if (!isNaN(peTtmMin) || !isNaN(peTtmMax)) {
            metricsFilter.pe_ttm = [
              !isNaN(peTtmMin) ? peTtmMin : null,
              !isNaN(peTtmMax) ? peTtmMax : null,
            ];
          }

          // è‚¡æ¯ç‡ç­›é€‰
          const dyrMin = parseFloat(document.getElementById("dyrMin").value);
          const dyrMax = parseFloat(document.getElementById("dyrMax").value);
          if (!isNaN(dyrMin) || !isNaN(dyrMax)) {
            metricsFilter.dyr = [
              !isNaN(dyrMin) ? dyrMin : null,
              !isNaN(dyrMax) ? dyrMax : null,
            ];
          }

          // å¸‚å‡€ç‡ PB ç­›é€‰
          const pbMin = parseFloat(document.getElementById("pbMin").value);
          const pbMax = parseFloat(document.getElementById("pbMax").value);
          if (!isNaN(pbMin) || !isNaN(pbMax)) {
            metricsFilter.pb = [
              !isNaN(pbMin) ? pbMin : null,
              !isNaN(pbMax) ? pbMax : null,
            ];
          }

          // å¸‚å€¼ MC ç­›é€‰ï¼ˆæ³¨æ„ï¼šAPIè¿”å›çš„å¸‚å€¼å•ä½éœ€è¦ç¡®è®¤ï¼Œè¿™é‡Œå‡è®¾æ˜¯å…ƒï¼‰
          const mcMin = parseFloat(document.getElementById("mcMin").value);
          const mcMax = parseFloat(document.getElementById("mcMax").value);
          if (!isNaN(mcMin) || !isNaN(mcMax)) {
            // å¸‚å€¼å•ä½è½¬æ¢ï¼šå‰ç«¯è¾“å…¥ä¸‡å…ƒï¼Œè½¬æ¢ä¸ºå…ƒï¼ˆAPIè¿”å›çš„å¯èƒ½æ˜¯å…ƒï¼‰
            // å¦‚æœAPIè¿”å›çš„æ˜¯ä¸‡å…ƒï¼Œåˆ™ä¸éœ€è¦ä¹˜ä»¥10000
            metricsFilter.mc = [
              !isNaN(mcMin) ? mcMin * 10000 : null, // ä¸‡å…ƒè½¬å…ƒ
              !isNaN(mcMax) ? mcMax * 10000 : null,
            ];
          }

          // æ£€æŸ¥æ˜¯å¦æœ‰ç­›é€‰æ¡ä»¶ï¼ˆè¿™ä¸ªæ£€æŸ¥å·²ç»åœ¨è°ƒç”¨å‰å®Œæˆï¼Œè¿™é‡Œåªä½œä¸ºé˜²å¾¡æ€§æ£€æŸ¥ï¼‰
          if (Object.keys(metricsFilter).length === 0) {
            throw new Error("ç¼ºå°‘ç­›é€‰æ¡ä»¶");
          }

          const requestData = {
            metricsFilter: metricsFilter,
            date: date,
          };

          console.log("å‘é€ç­›é€‰è¯·æ±‚:", requestData);

          const response = await fetch(BACKEND_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(requestData),
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(
              errorData.error || `HTTPé”™è¯¯!çŠ¶æ€ç : ${response.status}`
            );
          }

          const result = await response.json();
          console.log("æ¥å£äºŒè¿”å›çš„æ•°æ®:", result);

          // è¿”å›ç­›é€‰åçš„è‚¡ç¥¨æ•°æ®
          return result.data || [];
        } catch (error) {
          console.error("ç­›é€‰è‚¡ç¥¨å¤±è´¥:", error);
          throw error;
        }
      }

      // è®¡ç®—è¯„åˆ†
      function calculateRating(stocks) {
        return stocks.map((stock) => {
          let rating = 0;

          // è·å–æ•°æ®
          const peTtm = parseFloat(stock.pe_ttm) || 0;
          const pb = parseFloat(stock.pb) || 0;
          const mc = parseFloat(stock.mc) || 0;
          const dyr = parseFloat(stock.dyr) || 0;

          // å¸‚ç›ˆç‡TTMè¯„åˆ†ï¼ˆ0-15ä¸ºä¼˜ç§€ï¼‰
          if (peTtm > 0 && peTtm <= 15) {
            rating += 10;
          } else if (peTtm > 15 && peTtm <= 25) {
            rating += 5;
          } else if (peTtm > 0) {
            rating -= 5;
          }

          // å¸‚å‡€ç‡PBè¯„åˆ†ï¼ˆ0-2ä¸ºä¼˜ç§€ï¼‰
          if (pb > 0 && pb <= 2) {
            rating += 10;
          } else if (pb > 2 && pb <= 3) {
            rating += 5;
          } else if (pb > 0) {
            rating -= 5;
          }

          // è‚¡æ¯ç‡è¯„åˆ†ï¼ˆ>3%ä¸ºä¼˜ç§€ï¼‰
          if (dyr >= 3) {
            rating += 10;
          } else if (dyr > 0) {
            rating += 5;
          }

          // è·å–è‚¡ç¥¨åç§°
          const stockName = stock.stockName;

          return {
            ...stock,
            stockName: stockName,
            rating: rating,
          };
        });
      }

      // æ›´æ–°ç­›é€‰æ¡ä»¶æè¿°ï¼ˆå®æ—¶é¢„è§ˆï¼‰
      function updateFilterConditionsDescription() {
        const descriptionElement = document.getElementById(
          "filterConditionsDescription"
        );
        if (!descriptionElement) return;

        const stockCodeInput = document.getElementById("stockCode");
        const hasStockCode =
          (stockCodeInput ? stockCodeInput.value.trim() : "").length !== 0;
        if (hasStockCode) {
          descriptionElement.textContent = "";
          descriptionElement.style.display = "none";
          return;
        }

        // æ„å»ºç­›é€‰æ¡ä»¶æè¿°
        const conditions = [];

        // ä»é…ç½®ä¸­åŠ¨æ€è·å–æ‰€æœ‰ç­›é€‰å­—æ®µ
        const fields = window.FILTER_FIELDS || FILTER_FIELDS || [];

        fields.forEach((field) => {
          if (!field.minId || !field.maxId) return;

          const minInput = document.getElementById(field.minId);
          const maxInput = document.getElementById(field.maxId);

          // å¦‚æœå…ƒç´ ä¸å­˜åœ¨ï¼Œè·³è¿‡
          if (!minInput && !maxInput) return;

          const minValue = minInput ? parseFloat(minInput.value) : NaN;
          const maxValue = maxInput ? parseFloat(maxInput.value) : NaN;

          // å¦‚æœè‡³å°‘æœ‰ä¸€ä¸ªå€¼ï¼Œæ„å»ºæ¡ä»¶æè¿°
          if (!isNaN(minValue) || !isNaN(maxValue)) {
            let condition = field.label || field.key;
            if (!isNaN(minValue) && !isNaN(maxValue)) {
              condition += ` ${minValue} ~ ${maxValue}`;
            } else if (!isNaN(minValue)) {
              condition += ` â‰¥ ${minValue}`;
            } else {
              condition += ` â‰¤ ${maxValue}`;
            }
            conditions.push(condition);
          }
        });

        // æ›´æ–°æ˜¾ç¤º
        if (conditions.length > 0) {
          descriptionElement.textContent = `ç­›é€‰æ¡ä»¶ï¼š${conditions.join("ï¼Œ")}`;
          descriptionElement.style.display = "block";
        } else {
          descriptionElement.textContent = "";
          descriptionElement.style.display = "none";
        }
      }

      // æ˜¾ç¤ºç»“æœ
      function displayResults(stocks) {
        const container = document.getElementById("resultTable");
        const countElement = document.getElementById("resultCount");

        countElement.textContent = `å…± ${stocks.length} æ¡ç»“æœ`;

        if (stocks.length === 0) {
          showNoResults();
          return;
        }

        // åˆ›å»ºè¡¨æ ¼
        let html = `
                <div class="overflow-x-auto">
                  <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-700">
                      <tr>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-white uppercase tracking-wider">è‚¡ç¥¨åç§°</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-white uppercase tracking-wider">è‚¡ç¥¨ä»£ç </th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-white uppercase tracking-wider">å¸‚ç›ˆç‡ TTM</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-white uppercase tracking-wider">å¸‚å‡€ç‡ PB</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-white uppercase tracking-wider">å¸‚å€¼ï¼ˆä¸‡å…ƒï¼‰</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-white uppercase tracking-wider">è‚¡æ¯ç‡ (%)</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-white uppercase tracking-wider">è¯„åˆ†</th>
                      </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
            `;

        // æ·»åŠ æ•°æ®è¡Œ
        stocks.forEach((stock) => {
          const ratingBgClass =
            stock.rating > 15
              ? "bg-green-100 text-green-800"
              : stock.rating > 0
              ? "bg-yellow-100 text-yellow-800"
              : "bg-red-100 text-red-800";

          // æ ¼å¼åŒ–å¸‚å€¼ï¼ˆå¦‚æœå­˜åœ¨ï¼Œå‡è®¾APIè¿”å›çš„æ˜¯å…ƒï¼Œè½¬æ¢ä¸ºä¸‡å…ƒæ˜¾ç¤ºï¼‰
          const mc = stock.mc ? (parseFloat(stock.mc) / 10000).toFixed(2) : "-";

          // æ„å»ºå¯Œé€”é“¾æ¥
          const futuUrl = stock.stockCode
            ? `https://www.futunn.com/stock/${stock.stockCode}-HK`
            : null;

          html += `
                      <tr class="group hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">
                          <span>${stock.stockName || ""}</span>
                          ${
                            futuUrl
                              ? `<a href="${futuUrl}" target="_blank" rel="noopener noreferrer" class="inline-flex items-center text-gray-400 hover:text-gray-600 opacity-0 group-hover:opacity-100 transition-opacity" title="åœ¨å¯Œé€”æŸ¥çœ‹">
                                  ğŸ”—
                                </a>`
                              : ""
                          }
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-800">${
                          stock.stockCode
                        }</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${
                          stock.pe_ttm
                            ? parseFloat(stock.pe_ttm).toFixed(2)
                            : "-"
                        }</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${
                          stock.pb ? parseFloat(stock.pb).toFixed(2) : "-"
                        }</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${mc}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${
                          stock.dyr ? parseFloat(stock.dyr).toFixed(2) : "-"
                        }</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                          <span class="px-3 py-1 inline-flex text-xs font-bold rounded-full ${ratingBgClass}">
                            ${stock.rating}
                          </span>
                        </td>
                      </tr>
                  `;
        });

        html += `
                    </tbody>
                  </table>
                </div>
            `;

        container.innerHTML = html;
      }

      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      function showLoading() {
        const container = document.getElementById("resultTable");
        container.innerHTML =
          '<button type="button" class="inline-flex cursor-not-allowed items-center rounded-md bg-gray-700 px-4 py-2 text-sm leading-6 font-semibold text-white transition duration-150 ease-in-out" disabled=""><svg class="mr-3 -ml-1 size-5 animate-spin text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>æ­£åœ¨è·å–æ•°æ®...</button>';
      }

      // æ˜¾ç¤ºæ— ç»“æœçŠ¶æ€
      function showNoResults() {
        const container = document.getElementById("resultTable");
        container.innerHTML =
          '<div class="text-center py-16 text-gray-500 bg-gray-50 rounded-lg"><div>æš‚æ— ç»“æœ</div></div>';
        document.getElementById("resultCount").textContent = "";
      }
    </script>
  </body>
</html>
